<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX DEX äº¤æ˜“ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            font-size: 14px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .content {
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            width: auto;
            margin-bottom: 5px;
            margin-right: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            display: none;
            font-size: 0.9em;
            word-wrap: break-word;
            clear: both;
            width: 100%;
            min-height: 50px;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .token-info {
            margin-top: 8px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background-color: #f8f9fa;
            display: none;
            font-size: 0.85em;
        }

        .token-info.show {
            display: block;
        }

        .token-info.success {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }

        .token-info.error {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }

        .amount-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .amount-input-group input {
            flex: 2;
        }

        .amount-input-group select {
            flex: 1;
            min-width: 120px;
        }

        .conversion-text {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            font-family: monospace;
        }

        .token-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .token-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .token-btn:hover {
            transform: translateY(-1px);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .info-item label {
            margin-bottom: 5px;
            color: #666;
            font-size: 0.8em;
        }

        .info-item span {
            font-weight: 600;
            color: #333;
        }

        .quote-result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .quote-header {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .quote-details {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .quote-arrow {
            color: #4caf50;
            font-size: 1.5em;
            text-align: center;
        }

        .quote-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
            border-top: 1px solid #c8e6c9;
            padding-top: 8px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-row .form-group {
                margin-bottom: 15px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .quote-details {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }

        small {
            font-size: 0.8em;
            color: #666;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* å¯¹è¯æ¡†æ ·å¼ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dialog {
            background: white;
            padding: 25px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dialog h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ OKX DEX äº¤æ˜“ç•Œé¢</h1>
            <p>å®‰å…¨ã€å¿«é€Ÿçš„å»ä¸­å¿ƒåŒ–äº¤æ˜“ä½“éªŒ</p>
        </div>

        <div class="content">
            <!-- è§£é”ç•Œé¢ -->
            <div id="unlockSection" class="section" style="display: none;">
                <h3>ğŸ”“ è§£é”é…ç½®</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                    æ£€æµ‹åˆ°å·²ä¿å­˜çš„åŠ å¯†é…ç½®ï¼Œè¯·è¾“å…¥å¯†ç è§£é”ï¼š
                </p>
                
                <div class="form-group">
                    <label for="unlockPassword">è§£é”å¯†ç :</label>
                    <input type="password" id="unlockPassword" placeholder="è¾“å…¥æ‚¨çš„è§£é”å¯†ç " 
                           onkeypress="if(event.key==='Enter') unlockConfig()" />
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="unlockConfig()">ğŸ”“ è§£é”é…ç½®</button>
                    <button class="btn" onclick="showNewConfigForm()" 
                            style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">
                        ğŸ†• æ–°å»ºé…ç½®
                    </button>
                </div>
                
                <div style="text-align: center;">
                    <small style="color: #666;">
                        å¿˜è®°å¯†ç ï¼Ÿ 
                        <a href="#" onclick="confirmClearConfig()" style="color: #e74c3c;">
                            æ¸…é™¤ä¿å­˜çš„é…ç½®
                        </a>
                    </small>
                </div>
                
                <div id="unlockResult" class="result"></div>
            </div>

            <!-- é…ç½®éƒ¨åˆ† -->
            <div id="configSection" class="section">
                <h3>ğŸ” é…ç½®è®¾ç½®</h3>
                
                <!-- é…ç½®æ§åˆ¶æŒ‰é’® -->
                <div id="configControls" class="btn-group" style="display: none;">
                    <button class="btn btn-small" onclick="lockConfig()" style="background: #6c757d;">ğŸ”’ é”å®š</button>
                    <button class="btn btn-small" onclick="showSavePasswordDialog()" style="background: #28a745;">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn btn-small" onclick="validateOKXAPI()" style="background: #17a2b8;">ğŸ” éªŒè¯API</button>
                </div>
                
                <!-- OKX API é…ç½® -->
                <h4 style="margin: 15px 0 10px 0; color: #667eea; font-size: 1em;">OKX API é…ç½®</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="okxApiKey">API Key:</label>
                        <input type="text" id="okxApiKey" placeholder="è¾“å…¥ OKX API Key" />
                    </div>
                    <div class="form-group">
                        <label for="okxSecretKey">Secret Key:</label>
                        <input type="password" id="okxSecretKey" placeholder="è¾“å…¥ Secret Key" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="okxPassphrase">Passphrase:</label>
                        <input type="password" id="okxPassphrase" placeholder="è¾“å…¥ API Passphrase" />
                    </div>
                    <div class="form-group">
                        <label for="okxProjectId">Project ID:</label>
                        <input type="text" id="okxProjectId" placeholder="è¾“å…¥é¡¹ç›® ID" />
                    </div>
                </div>
                
                <!-- ç½‘ç»œå’Œé’±åŒ…é…ç½® -->
                <h4 style="margin: 15px 0 10px 0; color: #667eea; font-size: 1em;">ç½‘ç»œä¸é’±åŒ…é…ç½®</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="chainId">åŒºå—é“¾:</label>
                        <select id="chainId" onchange="updateChainConfig()">
                            <option value="1">ä»¥å¤ªåŠ (1)</option>
                            <option value="8453">Base (8453)</option>
                            <option value="56">BSC (56)</option>
                            <option value="137">Polygon (137)</option>
                            <option value="42161">Arbitrum (42161)</option>
                            <option value="10">Optimism (10)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rpcUrl">RPC URL:</label>
                        <input type="text" id="rpcUrl" placeholder="https://eth-mainnet.alchemyapi.io/v2/your_key" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="walletAddress">é’±åŒ…åœ°å€:</label>
                        <input type="text" id="walletAddress" placeholder="0x742d35Cc..." />
                    </div>
                    <div class="form-group">
                        <label for="privateKey">ç§é’¥:</label>
                        <input type="password" id="privateKey" placeholder="ç§é’¥ (ä¸å«0x)" />
                    </div>
                </div>
                
                <button class="btn" onclick="setConfigWithSave()">è®¾ç½®é…ç½®</button>
                <div id="validateResult" class="result"></div>
                <div id="configResult" class="result"></div>
            </div>

            <!-- è´¦æˆ·ä¿¡æ¯ -->
            <div class="section">
                <h3>ğŸ“Š è´¦æˆ·ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>è¿æ¥çŠ¶æ€:</label>
                        <span id="connectionStatus" class="status disconnected">æœªè¿æ¥</span>
                    </div>
                    <div class="info-item">
                        <label>ETH ä½™é¢:</label>
                        <span id="ethBalance">--</span>
                    </div>
                </div>
                <div class="info-item" style="margin-bottom: 15px;">
                    <label>é’±åŒ…åœ°å€:</label>
                    <span id="currentAddress" style="font-family: monospace; font-size: 0.8em; word-break: break-all;">æœªè®¾ç½®</span>
                </div>
                <button class="btn" onclick="loadAccountInfo()">åˆ·æ–°è´¦æˆ·ä¿¡æ¯</button>
            </div>

            <!-- ä»£å¸äº¤æ¢ -->
            <div class="section">
                <h3>ğŸ’° ä»£å¸äº¤æ¢</h3>
                
                <!-- å¿«æ·ä»£å¸é€‰æ‹© -->
                <div style="margin-bottom: 15px;">
                    <label style="margin-bottom: 8px;">å¿«æ·é€‰æ‹©ä»£å¸:</label>
                    <div class="token-buttons" id="tokenButtons">
                        <button class="token-btn" onclick="selectToken('from', '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE')">ETH</button>
                        <button class="token-btn" onclick="selectToken('from', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48')">USDC</button>
                        <button class="token-btn" onclick="selectToken('from', '0xdAC17F958D2ee523a2206206994597C13D831ec7')">USDT</button>
                        <button class="token-btn" onclick="selectToken('from', '0x6B175474E89094C44Da98b954EedeAC495271d0F')">DAI</button>
                    </div>
                </div>

                <!-- ä»£å¸é€‰æ‹© -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="fromToken">ä»ä»£å¸åœ°å€:</label>
                        <input type="text" id="fromToken" placeholder="0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE" 
                               oninput="debounceGetTokenInfo('from')" />
                        <div id="fromTokenInfo" class="token-info"></div>
                    </div>
                    <div class="form-group">
                        <label for="toToken">åˆ°ä»£å¸åœ°å€:</label>
                        <input type="text" id="toToken" placeholder="0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48" 
                               oninput="debounceGetTokenInfo('to')" />
                        <div id="toTokenInfo" class="token-info"></div>
                    </div>
                </div>
                
                <!-- äº¤æ¢å‚æ•° -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">äº¤æ¢æ•°é‡:</label>
                        <div class="amount-input-group">
                            <input type="text" id="amount" placeholder="1.0" oninput="updateAmountConversion()" />
                            <select id="amountUnit" onchange="updateAmountConversion()">
                                <option value="ether">ä»£å¸å•ä½</option>
                                <option value="wei">Weiå•ä½</option>
                            </select>
                        </div>
                        <div id="amountConversion" class="conversion-text"></div>
                    </div>
                    <div class="form-group">
                        <label for="slippage">æ»‘ç‚¹å®¹å¿åº¦ (%):</label>
                        <input type="text" id="slippage" value="0.5" placeholder="0.5" />
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="btn-group">
                    <button class="btn" onclick="getQuote()">è·å–æŠ¥ä»·</button>
                    <button class="btn" onclick="approveToken()" style="background: linear-gradient(45deg, #ff9500, #ff6b6b);">æˆæƒä»£å¸</button>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="executeSwap()">æ‰§è¡Œäº¤æ¢</button>
                </div>
                
                <!-- ç»“æœæ˜¾ç¤º -->
                <div id="quoteResult" class="result"></div>
                <div id="approveResult" class="result"></div>
                <div id="swapResult" class="result"></div>
            </div>

            <!-- äº¤æ˜“è¿½è¸ª -->
            <div class="section">
                <h3>ğŸ” äº¤æ˜“è¿½è¸ª</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="orderId">è®¢å•IDæˆ–äº¤æ˜“å“ˆå¸Œ:</label>
                        <input type="text" id="orderId" placeholder="è¾“å…¥è®¢å•IDæˆ–äº¤æ˜“å“ˆå¸Œ" />
                    </div>
                </div>
                <button class="btn" onclick="trackTransaction()">è¿½è¸ªäº¤æ˜“çŠ¶æ€</button>
                <div id="trackResult" class="result"></div>
            </div>
        </div>

        <!-- ä¿å­˜å¯†ç å¯¹è¯æ¡† -->
        <div id="savePasswordDialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h4>ğŸ” è®¾ç½®ä¿å­˜å¯†ç </h4>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                    è®¾ç½®å¯†ç æ¥åŠ å¯†ä¿å­˜é…ç½®ä¿¡æ¯ï¼š
                </p>
                
                <div class="form-group">
                    <label for="savePassword">ä¿å­˜å¯†ç :</label>
                    <input type="password" id="savePassword" placeholder="è®¾ç½®å¼ºå¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰" 
                           onkeypress="if(event.key==='Enter') confirmSaveConfig()" />
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">ç¡®è®¤å¯†ç :</label>
                    <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥å¯†ç " 
                           onkeypress="if(event.key==='Enter') confirmSaveConfig()" />
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="confirmSaveConfig()" style="background: #28a745;">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn" onclick="closeSavePasswordDialog()" style="background: #6c757d;">å–æ¶ˆ</button>
                </div>
                
                <div id="savePasswordResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        // åŠ å¯†è§£å¯†å·¥å…·ç±»
        class CryptoUtils {
            // ä½¿ç”¨PBKDF2ä»å¯†ç ç”Ÿæˆå¯†é’¥
            static async deriveKey(password, salt) {
                const encoder = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                return window.crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode(salt),
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
            }
            
            // åŠ å¯†æ•°æ®
            static async encrypt(data, password) {
                try {
                    const encoder = new TextEncoder();
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    
                    const key = await this.deriveKey(password, salt);
                    const encrypted = await window.crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encoder.encode(JSON.stringify(data))
                    );
                    
                    // å°†saltã€ivå’ŒåŠ å¯†æ•°æ®ç»„åˆ
                    const result = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                    result.set(salt, 0);
                    result.set(iv, salt.length);
                    result.set(new Uint8Array(encrypted), salt.length + iv.length);
                    
                    return btoa(String.fromCharCode(...result));
                } catch (error) {
                    throw new Error('åŠ å¯†å¤±è´¥: ' + error.message);
                }
            }
            
            // è§£å¯†æ•°æ®
            static async decrypt(encryptedData, password) {
                try {
                    const data = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
                    
                    const salt = data.slice(0, 16);
                    const iv = data.slice(16, 28);
                    const encrypted = data.slice(28);
                    
                    const key = await this.deriveKey(password, salt);
                    const decrypted = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encrypted
                    );
                    
                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decrypted));
                } catch (error) {
                    throw new Error('è§£å¯†å¤±è´¥: å¯†ç é”™è¯¯æˆ–æ•°æ®æŸå');
                }
            }
        }

        // é…ç½®ç®¡ç†ç±»
        class ConfigManager {
            static STORAGE_KEY = 'okx_dex_encrypted_config';
            static isUnlocked = false;
            static currentConfig = null;
            
            // ä¿å­˜åŠ å¯†é…ç½®
            static async saveEncryptedConfig(config, password) {
                try {
                    // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
                    const sensitiveConfig = {
                        okxApiKey: config.okxApiKey,
                        okxSecretKey: config.okxSecretKey,
                        okxPassphrase: config.okxPassphrase,
                        okxProjectId: config.okxProjectId,
                        privateKey: config.privateKey,
                        walletAddress: config.walletAddress,
                        rpcUrl: config.rpcUrl,
                        chainId: config.chainId,
                        savedAt: new Date().toISOString()
                    };
                    
                    const encrypted = await CryptoUtils.encrypt(sensitiveConfig, password);
                    localStorage.setItem(this.STORAGE_KEY, encrypted);
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    return false;
                }
            }
            
            // åŠ è½½å¹¶è§£å¯†é…ç½®
            static async loadEncryptedConfig(password) {
                try {
                    const encrypted = localStorage.getItem(this.STORAGE_KEY);
                    if (!encrypted) {
                        throw new Error('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„é…ç½®');
                    }
                    
                    const config = await CryptoUtils.decrypt(encrypted, password);
                    this.isUnlocked = true;
                    this.currentConfig = config;
                    return config;
                } catch (error) {
                    this.isUnlocked = false;
                    this.currentConfig = null;
                    throw error;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„é…ç½®
            static hasEncryptedConfig() {
                return localStorage.getItem(this.STORAGE_KEY) !== null;
            }
            
            // åˆ é™¤ä¿å­˜çš„é…ç½®
            static clearEncryptedConfig() {
                localStorage.removeItem(this.STORAGE_KEY);
                this.isUnlocked = false;
                this.currentConfig = null;
            }
            
            // é”å®šé…ç½®
            static lock() {
                this.isUnlocked = false;
                this.currentConfig = null;
                // æ¸…ç©ºè¡¨å•
                this.clearForm();
                // æ˜¾ç¤ºè§£é”ç•Œé¢
                this.showUnlockInterface();
            }
            
            // æ¸…ç©ºè¡¨å•
            static clearForm() {
                ['okxApiKey', 'okxSecretKey', 'okxPassphrase', 'okxProjectId', 
                 'privateKey', 'walletAddress', 'rpcUrl'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
            }
            
            // å¡«å……è¡¨å•
            static fillForm(config) {
                Object.keys(config).forEach(key => {
                    const element = document.getElementById(key);
                    if (element && config[key]) {
                        element.value = config[key];
                    }
                });
                
                // æ›´æ–°é“¾é…ç½®
                if (config.chainId) {
                    document.getElementById('chainId').value = config.chainId;
                    updateChainConfig();
                }
            }
            
            // æ˜¾ç¤ºè§£é”ç•Œé¢
            static showUnlockInterface() {
                const hasConfig = this.hasEncryptedConfig();
                const unlockSection = document.getElementById('unlockSection');
                const configSection = document.getElementById('configSection');
                
                if (hasConfig) {
                    unlockSection.style.display = 'block';
                    configSection.style.display = 'none';
                } else {
                    unlockSection.style.display = 'none';
                    configSection.style.display = 'block';
                }
            }
            
            // æ˜¾ç¤ºé…ç½®ç•Œé¢
            static showConfigInterface() {
                const unlockSection = document.getElementById('unlockSection');
                const configSection = document.getElementById('configSection');
                
                unlockSection.style.display = 'none';
                configSection.style.display = 'block';
            }
        }

        // é˜²æŠ–å®šæ—¶å™¨
        let tokenInfoTimeouts = {};

        // å¿«é€Ÿé€‰æ‹©ä»£å¸
        function selectToken(type, address) {
            const inputId = type === 'from' ? 'fromToken' : 'toToken';
            document.getElementById(inputId).value = address;
            getTokenInfo(type, address);
        }

        // é˜²æŠ–è·å–ä»£å¸ä¿¡æ¯
        function debounceGetTokenInfo(type) {
            const address = document.getElementById(type === 'from' ? 'fromToken' : 'toToken').value;
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (tokenInfoTimeouts[type]) {
                clearTimeout(tokenInfoTimeouts[type]);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            tokenInfoTimeouts[type] = setTimeout(() => {
                if (address && address.length >= 42) {
                    getTokenInfo(type, address);
                } else {
                    hideTokenInfo(type);
                }
            }, 500);
        }

        // è·å–ä»£å¸ä¿¡æ¯
        async function getTokenInfo(type, address) {
            const infoId = type === 'from' ? 'fromTokenInfo' : 'toTokenInfo';
            const infoElement = document.getElementById(infoId);
            
            if (!address || address.length < 42) {
                hideTokenInfo(type);
                return;
            }
            
            try {
                infoElement.className = 'token-info show';
                infoElement.innerHTML = '<span class="loading"></span>è·å–ä»£å¸ä¿¡æ¯ä¸­...';
                
                const result = await apiCall(`/api/token-info/${address}`);
                
                if (result.success) {
                    infoElement.className = 'token-info show success';
                    infoElement.innerHTML = `
                        <strong>${result.data.symbol}</strong> - ${result.data.name}<br>
                        <small>ç²¾åº¦: ${result.data.decimals} ä½</small>
                    `;
                } else {
                    infoElement.className = 'token-info show error';
                    infoElement.innerHTML = `âŒ ${result.message}`;
                }
            } catch (error) {
                infoElement.className = 'token-info show error';
                infoElement.innerHTML = `âŒ è·å–ä»£å¸ä¿¡æ¯å¤±è´¥: ${error.message}`;
            }
        }

        // éšè—ä»£å¸ä¿¡æ¯
        function hideTokenInfo(type) {
            const infoId = type === 'from' ? 'fromTokenInfo' : 'toTokenInfo';
            const infoElement = document.getElementById(infoId);
            if (infoElement) {
                infoElement.className = 'token-info';
                infoElement.innerHTML = '';
            }
        }

        // æ›´æ–°æ•°é‡åŠ©æ‰‹ - ç§»é™¤ç‰ˆæœ¬ï¼Œé¿å…è®¿é—®ä¸å­˜åœ¨çš„å…ƒç´ 
        function updateAmountHelper(type, tokenData) {
            // ä¸å†æ˜¾ç¤ºæ•°é‡åŠ©æ‰‹ï¼Œç®€åŒ–ç•Œé¢
            return;
        }

        // API è°ƒç”¨å‡½æ•°
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(endpoint, options);
                return await response.json();
            } catch (error) {
                return {
                    success: false,
                    message: error.message
                };
            }
        }

        // æ˜¾ç¤ºç»“æœ - ä¼˜åŒ–ç‰ˆæœ¬
        function showResult(elementId, result, isSuccess = null) {
            const element = document.getElementById(elementId);
            const success = isSuccess !== null ? isSuccess : result.success;
            
            element.className = `result ${success ? 'success' : 'error'}`;
            element.style.display = 'block';
            
            if (typeof result === 'object') {
                let displayContent = '';
                
                if (!success && result.message) {
                    // ç®€åŒ–é”™è¯¯ä¿¡æ¯æ˜¾ç¤º - æ”¹è¿›ç‰ˆæœ¬
                    if (result.message.includes('è¯·å…ˆé…ç½®') || result.message.includes('å®¢æˆ·ç«¯æœªåˆå§‹åŒ–')) {
                        displayContent = `âš ï¸ è¯·å…ˆå®Œæˆé…ç½®è®¾ç½® - å¡«å†™å¹¶ä¿å­˜OKX APIå’Œé’±åŒ…é…ç½®ä¿¡æ¯`;
                    } else if (result.message.includes('status code 401') || result.message.includes('APIè®¤è¯å¤±è´¥')) {
                        displayContent = `âŒ APIè®¤è¯å¤±è´¥ - è¯·æ£€æŸ¥OKX APIé…ç½®ä¿¡æ¯æ˜¯å¦æ­£ç¡®`;
                    } else if (result.message.includes('Insufficient liquidity')) {
                        displayContent = `âš ï¸ æµåŠ¨æ€§ä¸è¶³ - è¯·å°è¯•å‡å°‘äº¤æ¢æ•°é‡æˆ–æ›´æ¢ä»£å¸å¯¹`;
                    } else if (result.message.includes('ç½‘ç»œè¿æ¥') || result.message.includes('ECONNREFUSED')) {
                        displayContent = `âŒ ç½‘ç»œè¿æ¥å¤±è´¥ - è¯·æ£€æŸ¥RPC URLé…ç½®`;
                    } else if (result.message.includes('ç¼ºå°‘å¿…éœ€çš„å‚æ•°')) {
                        displayContent = `âŒ å‚æ•°é”™è¯¯ - è¯·æ£€æŸ¥ä»£å¸åœ°å€å’Œæ•°é‡æ˜¯å¦æ­£ç¡®å¡«å†™`;
                    } else {
                        displayContent = `âŒ ${result.message}`;
                    }
                } else if (success && result.data) {
                    // æ”¹è¿›æˆåŠŸä¿¡æ¯æ˜¾ç¤º
                    if (elementId === 'quoteResult') {
                        displayContent = formatQuoteResult(result.data);
                    } else if (elementId === 'swapResult') {
                        displayContent = formatSwapResult(result.data);
                    } else if (elementId === 'approveResult') {
                        displayContent = formatApprovalResult(result.data);
                    } else if (elementId === 'validateResult') {
                        displayContent = `âœ… APIé…ç½®éªŒè¯æˆåŠŸ`;
                    } else if (elementId === 'configResult') {
                        displayContent = `âœ… é…ç½®è®¾ç½®æˆåŠŸ`;
                    } else {
                        displayContent = `âœ… æ“ä½œæˆåŠŸ`;
                    }
                } else {
                    // æ˜¾ç¤ºåŸå§‹æ•°æ®ç”¨äºè°ƒè¯•
                    displayContent = `<pre style="max-height: 150px; overflow-y: auto; font-size: 0.8em;">${JSON.stringify(result, null, 2)}</pre>`;
                }
                
                element.innerHTML = displayContent;
            } else {
                element.textContent = result;
            }
        }

        // æ ¼å¼åŒ–æŠ¥ä»·ç»“æœ
        function formatQuoteResult(data) {
            console.log('å‰ç«¯æ¥æ”¶åˆ°çš„æŠ¥ä»·æ•°æ®:', data); // è°ƒè¯•æ—¥å¿—
            
            // æ£€æŸ¥æ•°æ®ç»“æ„ - é€‚é…åç«¯è¿”å›çš„æ ¼å¼
            if (!data) {
                return 'âŒ æœªè·å–åˆ°æŠ¥ä»·æ•°æ®';
            }

            // ä»è¿”å›çš„æ•°æ®ä¸­æå–å…³é”®ä¿¡æ¯ - ä¿®æ­£æ•°æ®è·¯å¾„
            let fromToken, toToken, fromTokenAmount, toTokenAmount, estimatedGas, priceImpact;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰routerResultï¼ˆæ–°æ ¼å¼ï¼‰
            if (data.routerResult) {
                fromToken = data.routerResult.fromToken;
                toToken = data.routerResult.toToken;
                fromTokenAmount = data.routerResult.fromTokenAmount;
                toTokenAmount = data.routerResult.toTokenAmount;
                estimatedGas = data.routerResult.estimateGasFee || '0';
                priceImpact = data.routerResult.priceImpactPercentage || '0';
            } else {
                // å…¼å®¹æ—§æ ¼å¼
                fromToken = data.fromToken;
                toToken = data.toToken;
                fromTokenAmount = data.fromTokenAmount;
                toTokenAmount = data.toTokenAmount;
                estimatedGas = data.estimateGasFee || '0';
                priceImpact = data.priceImpactPercentage || '0';
            }

            if (!fromToken || !toToken) {
                return 'âŒ æŠ¥ä»·æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ä»£å¸ä¿¡æ¯';
            }
            
            // è®¡ç®—æ•°é‡ï¼ˆä»weiè½¬æ¢ä¸ºä»£å¸å•ä½ï¼‰
            const fromAmount = fromTokenAmount ? (parseFloat(fromTokenAmount) / Math.pow(10, parseInt(fromToken.decimal || 18))).toFixed(6) : '0';
            const toAmount = toTokenAmount ? (parseFloat(toTokenAmount) / Math.pow(10, parseInt(toToken.decimal || 18))).toFixed(6) : '0';
            
            // è®¡ç®—ä»·æ ¼æ¯”ç‡
            const fromAmountNum = parseFloat(fromAmount);
            const toAmountNum = parseFloat(toAmount);
            const price = fromAmountNum > 0 ? (toAmountNum / fromAmountNum).toFixed(6) : '0';
            
            // æ˜¾ç¤ºDEXè·¯ç”±ä¿¡æ¯
            let routeInfo = '';
            const dexRouterList = data.routerResult?.dexRouterList || data.dexRouterList;
            if (dexRouterList && dexRouterList.length > 0) {
                const route = dexRouterList[0];
                if (route.subRouterList && route.subRouterList[0] && route.subRouterList[0].dexProtocol) {
                    const dexName = route.subRouterList[0].dexProtocol[0]?.dexName || 'æœªçŸ¥DEX';
                    routeInfo = `<div style="font-size: 0.75em; color: #666; margin-top: 4px;">é€šè¿‡ ${dexName} è·¯ç”±</div>`;
                }
            }
            
            // æ˜¾ç¤ºå¤šä¸ªDEXæ¯”è¾ƒä¿¡æ¯
            let compareInfo = '';
            const quoteCompareList = data.routerResult?.quoteCompareList || data.quoteCompareList;
            if (quoteCompareList && quoteCompareList.length > 1) {
                compareInfo = `<div style="font-size: 0.75em; color: #666; margin-top: 4px;">æ¯”è¾ƒäº† ${quoteCompareList.length} ä¸ªDEXï¼Œé€‰æ‹©æœ€ä¼˜è·¯ç”±</div>`;
            }
            
            return `
                <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 8px; margin: 4px 0; font-size: 0.85em;">
                    <div style="font-weight: bold; color: #2e7d32; margin-bottom: 6px;">ğŸ’° BSCé“¾æŠ¥ä»·ç»“æœ</div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span>æ”¯ä»˜: <strong>${fromAmount} ${fromToken.tokenSymbol}</strong></span>
                        <span style="color: #4caf50; margin: 0 8px;">â†’</span>
                        <span>è·å¾—: <strong style="color: #2e7d32;">${toAmount} ${toToken.tokenSymbol}</strong></span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 4px;">
                        <span>ä»·æ ¼: 1 ${fromToken.tokenSymbol} = ${price} ${toToken.tokenSymbol}</span>
                        <span>ä»·æ ¼å½±å“: ${priceImpact}%</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #888; margin-top: 2px;">
                        <span>é¢„ä¼°Gas: ${formatGasFee(estimatedGas)}</span>
                        <span>æ»‘ç‚¹å®¹å¿: ${data.slippage || '0.5'}%</span>
                    </div>
                    
                    ${routeInfo}
                    ${compareInfo}
                </div>
            `;
        }

        // æ ¼å¼åŒ–ä»£å¸æ•°é‡æ˜¾ç¤º
        function formatTokenAmount(amount, symbol) {
            if (!amount || amount === 0) return '0';
            
            const num = Number(amount);
            if (num >= 1e9) {
                return `${(num / 1e9).toFixed(2)}B ${symbol}`;
            } else if (num >= 1e6) {
                return `${(num / 1e6).toFixed(2)}M ${symbol}`;
            } else if (num >= 1e3) {
                return `${(num / 1e3).toFixed(2)}K ${symbol}`;
            } else if (num >= 1) {
                return `${num.toFixed(4)} ${symbol}`;
            } else {
                return `${num.toExponential(2)} ${symbol}`;
            }
        }

        // æ ¼å¼åŒ–Gasè´¹æ˜¾ç¤º
        function formatGasFee(gasFee) {
            const num = Number(gasFee);
            if (num === 0) return '0 BNB';
            
            const bnbValue = num / 1e18;
            if (bnbValue >= 0.01) {
                return `${bnbValue.toFixed(4)} BNB`;
            } else {
                return `${bnbValue.toExponential(2)} BNB`;
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function setLoading(buttonElement, loading = true) {
            if (loading) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<span class="loading"></span>å¤„ç†ä¸­...';
            } else {
                buttonElement.disabled = false;
                buttonElement.innerHTML = buttonElement.getAttribute('data-original-text') || 'æ‰§è¡Œ';
            }
        }

        // è®¾ç½®é…ç½®
        async function setConfig() {
            const okxApiKey = document.getElementById('okxApiKey').value;
            const okxSecretKey = document.getElementById('okxSecretKey').value;
            const okxPassphrase = document.getElementById('okxPassphrase').value;
            const okxProjectId = document.getElementById('okxProjectId').value;
            const rpcUrl = document.getElementById('rpcUrl').value;
            const chainId = document.getElementById('chainId').value;
            const walletAddress = document.getElementById('walletAddress').value;
            const privateKey = document.getElementById('privateKey').value;
            const btn = document.querySelector('button[onclick="setConfigWithSave()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }
            
            if (!okxApiKey || !okxSecretKey || !okxPassphrase || !okxProjectId || !rpcUrl || !chainId || !walletAddress || !privateKey) {
                showResult('configResult', { success: false, message: 'è¯·å¡«å†™æ‰€æœ‰é…ç½®é¡¹' }, false);
                return;
            }

            setLoading(btn);
            
            const result = await apiCall('/api/config', 'POST', {
                okxApiKey,
                okxSecretKey,
                okxPassphrase,
                okxProjectId,
                rpcUrl,
                chainId,
                walletAddress,
                privateKey
            });

            setLoading(btn, false);
            showResult('configResult', result);
            
            if (result.success) {
                loadAccountInfo();
            }
        }

        // ä¿®æ”¹åŸæœ‰çš„setConfigå‡½æ•°ï¼Œæ·»åŠ ä¿å­˜æç¤º
        async function setConfigWithSave() {
            // å…ˆæ‰§è¡ŒåŸæœ‰çš„è®¾ç½®é…ç½®é€»è¾‘
            await setConfig();
            
            // å¦‚æœé…ç½®æˆåŠŸä¸”æœªè§£é”çŠ¶æ€ï¼Œæç¤ºä¿å­˜
            if (!ConfigManager.isUnlocked) {
                const result = document.getElementById('configResult');
                if (result.classList.contains('success')) {
                    setTimeout(() => {
                        if (confirm('é…ç½®è®¾ç½®æˆåŠŸï¼æ˜¯å¦è¦åŠ å¯†ä¿å­˜åˆ°æœ¬åœ°ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¿«é€Ÿä½¿ç”¨ï¼Ÿ')) {
                            showSavePasswordDialog();
                        }
                    }, 1000);
                }
            }
        }

        // é‡‘é¢è½¬æ¢å·¥å…·å‡½æ•°
        function parseUnits(value, decimals = 18) {
            if (!value || isNaN(value)) return '0';
            
            // å¦‚æœå°æ•°ä½æ•°å¤§äºä»£å¸ç²¾åº¦ï¼Œæˆªæ–­
            const parts = value.toString().split('.');
            if (parts.length > 1 && parts[1].length > decimals) {
                const truncated = parts[0] + '.' + parts[1].slice(0, decimals);
                value = parseFloat(truncated);
            }
            
            // è½¬æ¢ä¸ºwei
            const factor = BigInt(10) ** BigInt(decimals);
            const integerPart = BigInt(Math.floor(value));
            const fractionalPart = value - Math.floor(value);
            
            const weiInteger = integerPart * factor;
            const weiFractional = BigInt(Math.round(fractionalPart * Number(factor)));
            
            return (weiInteger + weiFractional).toString();
        }

        function formatUnits(value, decimals = 18) {
            if (!value || value === '0') return '0';
            
            const factor = BigInt(10) ** BigInt(decimals);
            const bigValue = BigInt(value);
            
            const integerPart = bigValue / factor;
            const fractionalPart = bigValue % factor;
            
            const fractionalStr = fractionalPart.toString().padStart(decimals, '0');
            const trimmed = fractionalStr.replace(/0+$/, '');
            
            if (trimmed === '') {
                return integerPart.toString();
            } else {
                return integerPart.toString() + '.' + trimmed;
            }
        }

        // æ›´æ–°é‡‘é¢è½¬æ¢æ˜¾ç¤º
        function updateAmountConversion() {
            const amountInput = document.getElementById('amount');
            const unitSelect = document.getElementById('amountUnit');
            const conversionDiv = document.getElementById('amountConversion');
            
            if (!amountInput || !unitSelect || !conversionDiv) return;
            
            const value = amountInput.value;
            const unit = unitSelect.value;
            
            if (!value || isNaN(value) || parseFloat(value) <= 0) {
                conversionDiv.textContent = '';
                return;
            }
            
            if (unit === 'ether') {
                const weiValue = parseUnits(value, 18);
                // ç®€åŒ–æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºç§‘å­¦è®¡æ•°æ³•æˆ–è€…ç®€åŒ–çš„æ•°å­—
                const weiNumber = BigInt(weiValue);
                if (weiNumber >= BigInt('1000000000000000000')) {
                    const ethValue = Number(weiNumber) / 1e18;
                    conversionDiv.textContent = `= ${ethValue.toExponential(2)} wei`;
                } else {
                    conversionDiv.textContent = `= ${weiValue} wei`;
                }
            } else {
                const etherValue = formatUnits(value, 18);
                conversionDiv.textContent = `= ${etherValue} ä»£å¸å•ä½`;
            }
        }

        // è·å–æœ€ç»ˆçš„weié‡‘é¢
        function getFinalAmount() {
            const amountInput = document.getElementById('amount');
            const unitSelect = document.getElementById('amountUnit');
            
            if (!amountInput || !unitSelect) return '0';
            
            const value = amountInput.value;
            const unit = unitSelect.value;
            
            if (!value || isNaN(value) || parseFloat(value) <= 0) return '0';
            
            if (unit === 'ether') {
                return parseUnits(value, 18);
            } else {
                return value; // å·²ç»æ˜¯wei
            }
        }

        // åŠ è½½è´¦æˆ·ä¿¡æ¯
        async function loadAccountInfo() {
            const result = await apiCall('/api/account');
            
            if (result.success) {
                document.getElementById('connectionStatus').textContent = result.data.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                document.getElementById('connectionStatus').className = `status ${result.data.connected ? 'connected' : 'disconnected'}`;
                document.getElementById('ethBalance').textContent = result.data.ethBalance;
                document.getElementById('currentAddress').textContent = result.data.walletAddress;
            }
        }

        // æ£€æŸ¥é…ç½®æ˜¯å¦å·²è®¾ç½®
        function checkConfigurationReady() {
            const okxApiKey = document.getElementById('okxApiKey').value;
            const okxSecretKey = document.getElementById('okxSecretKey').value;
            const okxPassphrase = document.getElementById('okxPassphrase').value;
            const okxProjectId = document.getElementById('okxProjectId').value;
            const rpcUrl = document.getElementById('rpcUrl').value;
            const chainId = document.getElementById('chainId').value;
            const walletAddress = document.getElementById('walletAddress').value;
            const privateKey = document.getElementById('privateKey').value;

            if (!okxApiKey || !okxSecretKey || !okxPassphrase || !okxProjectId || 
                !rpcUrl || !chainId || !walletAddress || !privateKey) {
                return false;
            }
            return true;
        }

        // è·å–æŠ¥ä»·
        async function getQuote() {
            // æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
            if (!checkConfigurationReady()) {
                showResult('quoteResult', { 
                    success: false, 
                    message: 'è¯·å…ˆå®Œæˆé…ç½®è®¾ç½®ï¼šå¡«å†™å®Œæ•´çš„ OKX API é…ç½®ã€ç½‘ç»œé…ç½®å’Œé’±åŒ…ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»"è®¾ç½®é…ç½®"æŒ‰é’®' 
                }, false);
                return;
            }

            const fromTokenAddress = document.getElementById('fromToken').value;
            const toTokenAddress = document.getElementById('toToken').value;
            const amount = getFinalAmount(); // ä½¿ç”¨è½¬æ¢åçš„weié‡‘é¢
            const slippage = document.getElementById('slippage').value;
            const chainId = document.getElementById('chainId').value; // è·å–é“¾ID
            const btn = document.querySelector('button[onclick="getQuote()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!fromTokenAddress || !toTokenAddress) {
                showResult('quoteResult', { success: false, message: 'è¯·é€‰æ‹©è¦äº¤æ¢çš„ä»£å¸' }, false);
                return;
            }

            if (!amount || amount === '0') {
                showResult('quoteResult', { success: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡' }, false);
                return;
            }

            if (!chainId) {
                showResult('quoteResult', { success: false, message: 'è¯·é€‰æ‹©åŒºå—é“¾ç½‘ç»œ' }, false);
                return;
            }

            setLoading(btn);

            const result = await apiCall('/api/quote', 'POST', {
                fromTokenAddress,
                toTokenAddress,
                amount,
                slippage,
                chainIndex: chainId, // æ ¹æ®å®˜æ–¹æ–‡æ¡£ä½¿ç”¨chainIndex
                chainId: chainId,    // ä¿ç•™chainIdä»¥å…¼å®¹
                userWalletAddress: document.getElementById('walletAddress').value // æ¢å¤å¿…éœ€çš„å‚æ•°
            });

            setLoading(btn, false);
            showResult('quoteResult', result);
        }

        // æ‰§è¡Œäº¤æ¢
        async function executeSwap() {
            // æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
            if (!checkConfigurationReady()) {
                showResult('swapResult', { 
                    success: false, 
                    message: 'è¯·å…ˆå®Œæˆé…ç½®è®¾ç½®ï¼šå¡«å†™å®Œæ•´çš„ OKX API é…ç½®ã€ç½‘ç»œé…ç½®å’Œé’±åŒ…ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»"è®¾ç½®é…ç½®"æŒ‰é’®' 
                }, false);
                return;
            }

            const fromTokenAddress = document.getElementById('fromToken').value;
            const toTokenAddress = document.getElementById('toToken').value;
            const amount = getFinalAmount(); // ä½¿ç”¨è½¬æ¢åçš„weié‡‘é¢
            const slippage = document.getElementById('slippage').value;
            const chainId = document.getElementById('chainId').value; // è·å–é“¾ID
            const btn = document.querySelector('button[onclick="executeSwap()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!amount || amount === '0') {
                showResult('swapResult', { success: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡' }, false);
                return;
            }

            if (!chainId) {
                showResult('swapResult', { success: false, message: 'è¯·é€‰æ‹©åŒºå—é“¾ç½‘ç»œ' }, false);
                return;
            }

            if (!confirm('ç¡®å®šè¦æ‰§è¡Œäº¤æ¢å—ï¼Ÿè¿™å°†èŠ±è´¹çœŸå®çš„ä»£å¸å’ŒGasè´¹ç”¨ã€‚')) {
                return;
            }

            setLoading(btn);

            const result = await apiCall('/api/swap', 'POST', {
                fromTokenAddress,
                toTokenAddress,
                amount,
                slippage,
                chainIndex: chainId, // æ ¹æ®å®˜æ–¹æ–‡æ¡£ä½¿ç”¨chainIndex
                chainId: chainId,    // ä¿ç•™chainIdä»¥å…¼å®¹
                userWalletAddress: document.getElementById('walletAddress').value // æ¢å¤å¿…éœ€çš„å‚æ•°
            });

            setLoading(btn, false);
            showResult('swapResult', result);
            
            // å¦‚æœäº¤æ¢æˆåŠŸï¼Œè‡ªåŠ¨å¡«å……è®¢å•IDåˆ°è¿½è¸ªæ¡†
            if (result.success && result.data && result.data.orderId) {
                document.getElementById('orderId').value = result.data.orderId;
            }
        }

        // ä»£å¸æˆæƒ
        async function approveToken() {
            // æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
            if (!checkConfigurationReady()) {
                showResult('approveResult', { 
                    success: false, 
                    message: 'è¯·å…ˆå®Œæˆé…ç½®è®¾ç½®ï¼šå¡«å†™å®Œæ•´çš„ OKX API é…ç½®ã€ç½‘ç»œé…ç½®å’Œé’±åŒ…ä¿¡æ¯ï¼Œç„¶åç‚¹å‡»"è®¾ç½®é…ç½®"æŒ‰é’®' 
                }, false);
                return;
            }

            const fromTokenAddress = document.getElementById('fromToken').value;
            const amount = getFinalAmount(); // ä½¿ç”¨è½¬æ¢åçš„weié‡‘é¢
            const btn = document.querySelector('button[onclick="approveToken()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!fromTokenAddress) {
                showResult('approveResult', { success: false, message: 'è¯·é€‰æ‹©è¦æˆæƒçš„ä»£å¸' }, false);
                return;
            }

            // ETHä¸éœ€è¦æˆæƒ
            if (fromTokenAddress.toLowerCase() === '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee') {
                showResult('approveResult', { success: false, message: 'ETH ä¸éœ€è¦æˆæƒï¼Œå¯ä»¥ç›´æ¥äº¤æ¢' }, false);
                return;
            }

            if (!amount || amount === '0') {
                showResult('approveResult', { success: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æˆæƒæ•°é‡' }, false);
                return;
            }

            if (!confirm('ç¡®å®šè¦æˆæƒä»£å¸å—ï¼Ÿè¿™å°†èŠ±è´¹å°‘é‡Gasè´¹ç”¨ã€‚')) {
                return;
            }

            setLoading(btn);

            const result = await apiCall('/api/approve', 'POST', {
                tokenAddress: fromTokenAddress,
                amount: amount
            });

            setLoading(btn, false);
            showResult('approveResult', result);
        }

        // è¿½è¸ªäº¤æ˜“
        async function trackTransaction() {
            const orderId = document.getElementById('orderId').value;
            const btn = document.querySelector('button[onclick="trackTransaction()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!orderId) {
                showResult('trackResult', { success: false, message: 'è¯·è¾“å…¥è®¢å•ID' }, false);
                return;
            }

            setLoading(btn);

            const result = await apiCall(`/api/track/${orderId}`);

            setLoading(btn, false);
            showResult('trackResult', result);
        }

        // é¡µé¢åˆå§‹åŒ–
        function initializePage() {
            // ä¿å­˜åŸå§‹placeholder
            const amountInput = document.getElementById('amount');
            if (amountInput && !amountInput.getAttribute('data-original-placeholder')) {
                amountInput.setAttribute('data-original-placeholder', amountInput.placeholder);
            }
            
            // è®¾ç½®åˆå§‹é“¾é…ç½®
            updateChainConfig();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŠ å¯†é…ç½®
            ConfigManager.showUnlockInterface();
            
            // å¦‚æœæ²¡æœ‰åŠ å¯†é…ç½®ï¼Œå°è¯•åŠ è½½ä¼ ç»Ÿçš„è´¦æˆ·ä¿¡æ¯
            if (!ConfigManager.hasEncryptedConfig()) {
                loadAccountInfo();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // é“¾é…ç½®ä¿¡æ¯
        const CHAIN_CONFIG = {
            '1': {
                name: 'ä»¥å¤ªåŠä¸»ç½‘',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://eth-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48' },
                    { symbol: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7' },
                    { symbol: 'DAI', address: '0x6B175474E89094C44Da98b954EedeAC495271d0F' },
                    { symbol: 'WETH', address: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2' }
                ]
            },
            '56': {
                name: 'BSC',
                nativeToken: {
                    symbol: 'BNB',
                    name: 'BNB',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://bsc-dataseed.binance.org/',
                commonTokens: [
                    { symbol: 'USDT', address: '0x55d398326f99059fF775485246999027B3197955' },
                    { symbol: 'WBNB', address: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c' },
                    { symbol: 'USDC', address: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d' },
                    { symbol: 'BUSD', address: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56' }
                ]
            },
            '137': {
                name: 'Polygon',
                nativeToken: {
                    symbol: 'MATIC',
                    name: 'Polygon',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://polygon-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174' },
                    { symbol: 'USDT', address: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F' },
                    { symbol: 'WMATIC', address: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270' },
                    { symbol: 'WETH', address: '0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619' }
                ]
            },
            '8453': {
                name: 'Base',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://base-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913' },
                    { symbol: 'USDT', address: '0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2' },
                    { symbol: 'DAI', address: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb' },
                    { symbol: 'WETH', address: '0x4200000000000000000000000000000000000006' }
                ]
            },
            '42161': {
                name: 'Arbitrum',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://arb-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831' },
                    { symbol: 'USDT', address: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9' },
                    { symbol: 'DAI', address: '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1' },
                    { symbol: 'WETH', address: '0x82aF49447D8a07e3bd95BD0d56f35241523fBab1' }
                ]
            },
            '10': {
                name: 'Optimism',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://opt-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0x7F5c764cBc14f9669B88837ca1490cCa17c31607' },
                    { symbol: 'USDT', address: '0x94b008aA00579c1307B0EF2c499aD98a8ce58e58' },
                    { symbol: 'DAI', address: '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1' },
                    { symbol: 'WETH', address: '0x4200000000000000000000000000000000000006' }
                ]
            }
        };

        // å½“å‰é€‰æ‹©çš„é“¾ID
        let currentChainId = '1';

        // æ›´æ–°é“¾é…ç½®
        function updateChainConfig() {
            const chainId = document.getElementById('chainId').value;
            const rpcUrlInput = document.getElementById('rpcUrl');
            
            currentChainId = chainId;
            const chainConfig = CHAIN_CONFIG[chainId];
            
            if (chainConfig && !rpcUrlInput.value.includes('your_key')) {
                // åªæœ‰å½“ç”¨æˆ·æ²¡æœ‰è‡ªå®šä¹‰RPCæ—¶æ‰æ›´æ–°
                if (chainConfig.rpcUrl.includes('your_key')) {
                    rpcUrlInput.placeholder = `è¯·è¾“å…¥ ${chainConfig.name} çš„ RPC URL`;
                } else {
                    rpcUrlInput.value = chainConfig.rpcUrl;
                }
            }
            
            // æ›´æ–°å¿«æ·ä»£å¸æŒ‰é’®
            updateNativeTokenButton(chainConfig);
            
            // æ›´æ–°ç¤ºä¾‹æ˜¾ç¤º
            updateExamples(chainConfig);
        }

        // æ›´æ–°åŸç”Ÿä»£å¸æŒ‰é’®
        function updateNativeTokenButton(chainConfig) {
            const tokenButtons = document.querySelector('.token-buttons');
            if (tokenButtons && chainConfig) {
                // æ¸…ç©ºç°æœ‰æŒ‰é’®
                tokenButtons.innerHTML = '';
                
                // æ·»åŠ åŸç”Ÿä»£å¸æŒ‰é’®
                const nativeButton = document.createElement('button');
                nativeButton.className = 'token-btn native-token-btn';
                nativeButton.textContent = chainConfig.nativeToken.symbol;
                nativeButton.onclick = () => selectToken('from', chainConfig.nativeToken.address);
                tokenButtons.appendChild(nativeButton);
                
                // æ·»åŠ å¸¸ç”¨ä»£å¸æŒ‰é’®
                chainConfig.commonTokens.forEach(token => {
                    const button = document.createElement('button');
                    button.className = 'token-btn';
                    button.textContent = token.symbol;
                    button.onclick = () => selectToken('from', token.address);
                    tokenButtons.appendChild(button);
                });
            }
        }

        // æ›´æ–°ç¤ºä¾‹æ˜¾ç¤º
        function updateExamples(chainConfig) {
            const amountInput = document.getElementById('amount');
            if (chainConfig && amountInput) {
                const symbol = chainConfig.nativeToken.symbol;
                const placeholder = amountInput.getAttribute('data-original-placeholder') || amountInput.placeholder;
                amountInput.placeholder = placeholder.replace('ETH', symbol);
                
                // æ›´æ–°ç¤ºä¾‹æ–‡æœ¬
                const small = amountInput.nextElementSibling;
                if (small && small.tagName === 'SMALL') {
                    small.textContent = `ç¤ºä¾‹: 0.001 ${symbol} = 1000000000000000`;
                }
            }
        }

        // è§£é”é…ç½®
        async function unlockConfig() {
            const password = document.getElementById('unlockPassword').value;
            const btn = document.querySelector('button[onclick="unlockConfig()"]');
            
            if (!password) {
                showResult('unlockResult', { success: false, message: 'è¯·è¾“å…¥è§£é”å¯†ç ' }, false);
                return;
            }
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }
            
            setLoading(btn);
            
            try {
                const config = await ConfigManager.loadEncryptedConfig(password);
                setLoading(btn, false);
                
                // å¡«å……è¡¨å•
                ConfigManager.fillForm(config);
                
                // æ˜¾ç¤ºé…ç½®ç•Œé¢
                ConfigManager.showConfigInterface();
                
                // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                document.getElementById('configControls').style.display = 'block';
                
                // æ¸…ç©ºå¯†ç æ¡†
                document.getElementById('unlockPassword').value = '';
                
                showResult('unlockResult', { 
                    success: true, 
                    message: `é…ç½®è§£é”æˆåŠŸï¼ä¿å­˜æ—¶é—´: ${new Date(config.savedAt).toLocaleString()}` 
                }, true);
                
                // 3ç§’åéšè—è§£é”ç»“æœ
                setTimeout(() => {
                    document.getElementById('unlockResult').style.display = 'none';
                }, 3000);
                
            } catch (error) {
                setLoading(btn, false);
                showResult('unlockResult', { success: false, message: error.message }, false);
            }
        }

        // æ˜¾ç¤ºæ–°å»ºé…ç½®è¡¨å•
        function showNewConfigForm() {
            if (confirm('è¿™å°†æ¸…é™¤å½“å‰ä¿å­˜çš„é…ç½®ï¼Œç¡®å®šè¦æ–°å»ºé…ç½®å—ï¼Ÿ')) {
                ConfigManager.clearEncryptedConfig();
                ConfigManager.showConfigInterface();
                document.getElementById('configControls').style.display = 'none';
            }
        }

        // ç¡®è®¤æ¸…é™¤é…ç½®
        function confirmClearConfig() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                ConfigManager.clearEncryptedConfig();
                ConfigManager.showConfigInterface();
                document.getElementById('configControls').style.display = 'none';
                showResult('unlockResult', { success: true, message: 'é…ç½®å·²æ¸…é™¤' }, true);
                setTimeout(() => {
                    document.getElementById('unlockResult').style.display = 'none';
                }, 2000);
            }
        }

        // é”å®šé…ç½®
        function lockConfig() {
            if (confirm('ç¡®å®šè¦é”å®šé…ç½®å—ï¼Ÿéœ€è¦é‡æ–°è¾“å…¥å¯†ç æ‰èƒ½è§£é”ã€‚')) {
                ConfigManager.lock();
            }
        }

        // æ˜¾ç¤ºä¿å­˜å¯†ç å¯¹è¯æ¡†
        function showSavePasswordDialog() {
            const dialog = document.getElementById('savePasswordDialog');
            dialog.style.display = 'flex';
            document.getElementById('savePassword').focus();
        }

        // å…³é—­ä¿å­˜å¯†ç å¯¹è¯æ¡†
        function closeSavePasswordDialog() {
            const dialog = document.getElementById('savePasswordDialog');
            dialog.style.display = 'none';
            document.getElementById('savePassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('savePasswordResult').style.display = 'none';
        }

        // ç¡®è®¤ä¿å­˜é…ç½®
        async function confirmSaveConfig() {
            const password = document.getElementById('savePassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!password || !confirmPassword) {
                showResult('savePasswordResult', { success: false, message: 'è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ' }, false);
                return;
            }
            
            if (password.length < 8) {
                showResult('savePasswordResult', { success: false, message: 'å¯†ç é•¿åº¦è‡³å°‘8ä½' }, false);
                return;
            }
            
            if (password !== confirmPassword) {
                showResult('savePasswordResult', { success: false, message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´' }, false);
                return;
            }
            
            // æ”¶é›†å½“å‰é…ç½®
            const config = {
                okxApiKey: document.getElementById('okxApiKey').value,
                okxSecretKey: document.getElementById('okxSecretKey').value,
                okxPassphrase: document.getElementById('okxPassphrase').value,
                okxProjectId: document.getElementById('okxProjectId').value,
                rpcUrl: document.getElementById('rpcUrl').value,
                chainId: document.getElementById('chainId').value,
                walletAddress: document.getElementById('walletAddress').value,
                privateKey: document.getElementById('privateKey').value
            };
            
            // éªŒè¯é…ç½®å®Œæ•´æ€§
            const requiredFields = ['okxApiKey', 'okxSecretKey', 'okxPassphrase', 'okxProjectId', 'rpcUrl', 'chainId', 'walletAddress', 'privateKey'];
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
                showResult('savePasswordResult', { 
                    success: false, 
                    message: `è¯·å…ˆå®Œæ•´å¡«å†™é…ç½®ä¿¡æ¯ï¼Œç¼ºå°‘: ${missingFields.join(', ')}` 
                }, false);
                return;
            }
            
            try {
                const success = await ConfigManager.saveEncryptedConfig(config, password);
                
                if (success) {
                    showResult('savePasswordResult', { 
                        success: true, 
                        message: 'é…ç½®ä¿å­˜æˆåŠŸï¼å·²åŠ å¯†å­˜å‚¨åˆ°æœ¬åœ°ã€‚' 
                    }, true);
                    
                    // 2ç§’åå…³é—­å¯¹è¯æ¡†
                    setTimeout(() => {
                        closeSavePasswordDialog();
                        // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                        document.getElementById('configControls').style.display = 'block';
                    }, 2000);
                    
                } else {
                    showResult('savePasswordResult', { success: false, message: 'ä¿å­˜é…ç½®å¤±è´¥' }, false);
                }
                
            } catch (error) {
                showResult('savePasswordResult', { success: false, message: 'ä¿å­˜å¤±è´¥: ' + error.message }, false);
            }
        }

        // éªŒè¯OKX APIé…ç½®
        async function validateOKXAPI() {
            const okxApiKey = document.getElementById('okxApiKey').value;
            const okxSecretKey = document.getElementById('okxSecretKey').value;
            const okxPassphrase = document.getElementById('okxPassphrase').value;
            const okxProjectId = document.getElementById('okxProjectId').value;
            const btn = document.querySelector('button[onclick="validateOKXAPI()"]');
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!okxApiKey || !okxSecretKey || !okxPassphrase || !okxProjectId) {
                showResult('validateResult', { 
                    success: false, 
                    message: 'è¯·å…ˆå¡«å†™å®Œæ•´çš„OKX APIé…ç½®ä¿¡æ¯' 
                }, false);
                return;
            }
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }
            
            setLoading(btn);
            
            try {
                const result = await apiCall('/api/validate-okx', 'POST', {
                    okxApiKey,
                    okxSecretKey,
                    okxPassphrase,
                    okxProjectId
                });
                
                setLoading(btn, false);
                
                if (result.success) {
                    showResult('validateResult', {
                        success: true,
                        message: 'âœ… OKX API é…ç½®éªŒè¯æˆåŠŸï¼å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚',
                        details: result.data
                    }, true);
                } else {
                    let errorContent = `âŒ ${result.message}`;
                    
                    if (result.debug) {
                        errorContent += `<br><br><strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong><br>`;
                        errorContent += `çŠ¶æ€ç : ${result.debug.status || 'N/A'}<br>`;
                        errorContent += `é”™è¯¯: ${result.debug.error || 'N/A'}<br>`;
                        
                        if (result.debug.possibleCauses) {
                            errorContent += `<br><strong>å¯èƒ½åŸå› ï¼š</strong><ul>`;
                            result.debug.possibleCauses.forEach(cause => {
                                errorContent += `<li>${cause}</li>`;
                            });
                            errorContent += `</ul>`;
                        }
                        
                        if (result.response) {
                            errorContent += `<br><strong>OKXå“åº”ï¼š</strong><br>`;
                            errorContent += `<pre style="font-size: 0.8em; max-height: 200px; overflow-y: auto;">${JSON.stringify(result.response, null, 2)}</pre>`;
                        }
                    }
                    
                    document.getElementById('validateResult').innerHTML = errorContent;
                    document.getElementById('validateResult').className = 'result error';
                    document.getElementById('validateResult').style.display = 'block';
                }
                
            } catch (error) {
                setLoading(btn, false);
                showResult('validateResult', { 
                    success: false, 
                    message: `ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error.message}` 
                }, false);
            }
        }

        // æ ¼å¼åŒ–äº¤æ¢ç»“æœ
        function formatSwapResult(data) {
            console.log('å‰ç«¯æ¥æ”¶åˆ°çš„äº¤æ¢ç»“æœ:', data); // è°ƒè¯•æ—¥å¿—
            
            if (!data) {
                return 'âŒ æ²¡æœ‰è¿”å›äº¤æ¢æ•°æ®';
            }

            let displayContent = '';
            
            // æ£€æŸ¥äº¤æ¢æ˜¯å¦æˆåŠŸ
            if (data.success === true && data.txHash) {
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">ğŸ‰ BSCé“¾äº¤æ¢æˆåŠŸï¼</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>äº¤æ˜“å“ˆå¸Œ:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.txHash}</code>
                        </div>
                        
                        ${data.orderId ? `
                        <div style="margin-bottom: 6px;">
                            <strong>è®¢å•ID:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.orderId}</code>
                        </div>
                        ` : ''}
                        
                        ${data.quote && data.quote.fromToken && data.quote.toToken ? `
                        <div style="margin-bottom: 6px; padding: 4px; background: #f8f9fa; border-radius: 2px;">
                            <strong>äº¤æ¢è¯¦æƒ…:</strong><br>
                            <span style="font-size: 0.85em;">
                                ${(parseFloat(data.quote.fromTokenAmount) / Math.pow(10, parseInt(data.quote.fromToken.decimal || 18))).toFixed(6)} ${data.quote.fromToken.tokenSymbol}
                                â†’ 
                                ${(parseFloat(data.quote.toTokenAmount) / Math.pow(10, parseInt(data.quote.toToken.decimal || 18))).toFixed(6)} ${data.quote.toToken.tokenSymbol}
                            </span>
                        </div>
                        ` : ''}
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            âœ… äº¤æ¢å·²åœ¨BSCé“¾ä¸ŠæˆåŠŸæ‰§è¡Œ
                        </div>
                    </div>
                `;
            } else if (data.success === false) {
                displayContent = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #721c24; margin-bottom: 6px;">âŒ BSCé“¾äº¤æ¢å¤±è´¥</div>
                        <div style="font-size: 0.85em; color: #666;">
                            é”™è¯¯ä¿¡æ¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    </div>
                `;
            } else if (data.orderId) {
                // å…¼å®¹æ—§æ ¼å¼
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">ğŸ‰ äº¤æ¢æäº¤æˆåŠŸï¼</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>è®¢å•ID:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px;">${data.orderId}</code>
                        </div>
                        
                        ${data.txHash ? `
                        <div style="margin-bottom: 6px;">
                            <strong>äº¤æ˜“å“ˆå¸Œ:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px;">${data.txHash}</code>
                        </div>
                        ` : ''}
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            â³ äº¤æ¢æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ä½¿ç”¨è®¢å•IDè¿½è¸ªäº¤æ˜“çŠ¶æ€
                        </div>
                    </div>
                `;
            } else {
                displayContent = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 6px;">âš ï¸ äº¤æ¢çŠ¶æ€æœªçŸ¥</div>
                        <div style="font-size: 0.85em; color: #666;">
                            æ²¡æœ‰æ”¶åˆ°æ˜ç¡®çš„äº¤æ¢ç»“æœï¼Œè¯·æ£€æŸ¥äº¤æ¢æ˜¯å¦æˆåŠŸæäº¤
                        </div>
                        <pre style="font-size: 0.75em; background: #f8f9fa; padding: 4px; border-radius: 2px; margin-top: 4px; max-height: 100px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            }

            return displayContent;
        }

        // æ ¼å¼åŒ–æˆæƒç»“æœ
        function formatApprovalResult(data) {
            console.log('å‰ç«¯æ¥æ”¶åˆ°çš„æˆæƒç»“æœ:', data); // è°ƒè¯•æ—¥å¿—
            
            if (!data) {
                return 'âŒ æ²¡æœ‰è¿”å›æˆæƒæ•°æ®';
            }

            let displayContent = '';
            
            if (data.needApproval === false) {
                displayContent = `
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #0c5460; margin-bottom: 6px;">â„¹ï¸ BSCä»£å¸å·²ç»æˆæƒ</div>
                        <div style="font-size: 0.85em; color: #666;">
                            è¯¥ä»£å¸å·²ç»æœ‰è¶³å¤Ÿçš„æˆæƒé¢åº¦ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œäº¤æ¢
                        </div>
                    </div>
                `;
            } else if (data.needApproval === true && data.txHash) {
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">âœ… BSCé“¾æˆæƒäº¤æ˜“æˆåŠŸ</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>äº¤æ˜“å“ˆå¸Œ:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.txHash}</code>
                        </div>
                        
                        ${data.orderId ? `
                        <div style="margin-bottom: 6px;">
                            <strong>è®¢å•ID:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.orderId}</code>
                        </div>
                        ` : ''}
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            âœ… ä»£å¸æˆæƒå·²åœ¨BSCé“¾ä¸ŠæˆåŠŸæ‰§è¡Œï¼Œç°åœ¨å¯ä»¥è¿›è¡Œäº¤æ¢
                        </div>
                    </div>
                `;
            } else if (data.txHash) {
                // å…¼å®¹æ—§æ ¼å¼
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">âœ… æˆæƒäº¤æ˜“å·²æäº¤</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>äº¤æ˜“å“ˆå¸Œ:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px;">${data.txHash}</code>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            â³ æˆæƒäº¤æ˜“æ­£åœ¨å¤„ç†ä¸­ï¼Œå®Œæˆåå³å¯è¿›è¡Œä»£å¸äº¤æ¢
                        </div>
                    </div>
                `;
            } else {
                displayContent = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 6px;">âš ï¸ æˆæƒçŠ¶æ€æœªçŸ¥</div>
                        <div style="font-size: 0.85em; color: #666;">
                            æˆæƒç»“æœä¸æ˜ç¡®ï¼Œè¯·æ£€æŸ¥é’±åŒ…æˆ–é‡æ–°å°è¯•
                        </div>
                        <pre style="font-size: 0.75em; background: #f8f9fa; padding: 4px; border-radius: 2px; margin-top: 4px; max-height: 100px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            }

            return displayContent;
        }
    </script>
</body>
</html> 