<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX DEX ‰∫§ÊòìÁïåÈù¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            font-size: 14px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .content {
            padding: 20px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            width: auto;
            margin-bottom: 5px;
            margin-right: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            display: none;
            font-size: 0.9em;
            word-wrap: break-word;
            clear: both;
            width: 100%;
            min-height: 50px;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .token-info {
            margin-top: 8px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background-color: #f8f9fa;
            display: none;
            font-size: 0.85em;
        }

        .token-info.show {
            display: block;
        }

        .token-info.success {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }

        .token-info.error {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }

        .amount-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .amount-input-group input {
            flex: 2;
        }

        .amount-input-group select {
            flex: 1;
            min-width: 120px;
        }

        .conversion-text {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            font-family: monospace;
        }

        .token-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .token-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .token-btn:hover {
            transform: translateY(-1px);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .info-item label {
            margin-bottom: 5px;
            color: #666;
            font-size: 0.8em;
        }

        .info-item span {
            font-weight: 600;
            color: #333;
        }

        .quote-result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .quote-header {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .quote-details {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .quote-arrow {
            color: #4caf50;
            font-size: 1.5em;
            text-align: center;
        }

        .quote-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
            border-top: 1px solid #c8e6c9;
            padding-top: 8px;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-row .form-group {
                margin-bottom: 15px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .quote-details {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }

        small {
            font-size: 0.8em;
            color: #666;
        }

        /* ÈöêËóèÁ±ª */
        .hidden {
            display: none !important;
        }

        /* ÂØπËØùÊ°ÜÊ†∑Âºè */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dialog {
            background: white;
            padding: 25px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dialog h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ OKX DEX ‰∫§ÊòìÁïåÈù¢</h1>
            <p>ÂÆâÂÖ®„ÄÅÂø´ÈÄüÁöÑÂéª‰∏≠ÂøÉÂåñ‰∫§Êòì‰ΩìÈ™å</p>
        </div>

        <div class="content">
            <!-- Ëß£ÈîÅÁïåÈù¢ -->
            <div id="unlockSection" class="section" style="display: none;">
                <h3>üîì Ëß£ÈîÅÈÖçÁΩÆ</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                    Ê£ÄÊµãÂà∞Â∑≤‰øùÂ≠òÁöÑÂä†ÂØÜÈÖçÁΩÆÔºåËØ∑ËæìÂÖ•ÂØÜÁ†ÅËß£ÈîÅÔºö
                </p>
                
                <div class="form-group">
                    <label for="unlockPassword">Ëß£ÈîÅÂØÜÁ†Å:</label>
                    <input type="password" id="unlockPassword" placeholder="ËæìÂÖ•ÊÇ®ÁöÑËß£ÈîÅÂØÜÁ†Å" 
                           onkeypress="if(event.key==='Enter') unlockConfig()" />
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="unlockConfig()">üîì Ëß£ÈîÅÈÖçÁΩÆ</button>
                    <button class="btn" onclick="showNewConfigForm()" 
                            style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">
                        üÜï Êñ∞Âª∫ÈÖçÁΩÆ
                    </button>
                </div>
                
                <div style="text-align: center;">
                    <small style="color: #666;">
                        ÂøòËÆ∞ÂØÜÁ†ÅÔºü 
                        <a href="#" onclick="confirmClearConfig()" style="color: #e74c3c;">
                            Ê∏ÖÈô§‰øùÂ≠òÁöÑÈÖçÁΩÆ
                        </a>
                    </small>
                </div>
                
                <div id="unlockResult" class="result"></div>
            </div>

            <!-- ÈÖçÁΩÆÈÉ®ÂàÜ -->
            <div id="configSection" class="section">
                <h3>üîê ÈÖçÁΩÆËÆæÁΩÆ</h3>
                
                <!-- ÈÖçÁΩÆÊéßÂà∂ÊåâÈíÆ -->
                <div id="configControls" class="btn-group" style="display: none;">
                    <button class="btn btn-small" onclick="lockConfig()" style="background: #6c757d;">üîí ÈîÅÂÆö</button>
                    <button class="btn btn-small" onclick="showSavePasswordDialog()" style="background: #28a745;">üíæ ‰øùÂ≠ò</button>
                    <button class="btn btn-small" onclick="validateOKXAPI()" style="background: #17a2b8;">üîç È™åËØÅAPI</button>
                </div>
                
                <!-- OKX API ÈÖçÁΩÆ -->
                <h4 style="margin: 15px 0 10px 0; color: #667eea; font-size: 1em;">OKX API ÈÖçÁΩÆ</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="okxApiKey">API Key:</label>
                        <input type="text" id="okxApiKey" placeholder="ËæìÂÖ• OKX API Key" />
                    </div>
                    <div class="form-group">
                        <label for="okxSecretKey">Secret Key:</label>
                        <input type="password" id="okxSecretKey" placeholder="ËæìÂÖ• Secret Key" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="okxPassphrase">Passphrase:</label>
                        <input type="password" id="okxPassphrase" placeholder="ËæìÂÖ• API Passphrase" />
                    </div>
                    <div class="form-group">
                        <label for="okxProjectId">Project ID:</label>
                        <input type="text" id="okxProjectId" placeholder="ËæìÂÖ•È°πÁõÆ ID" />
                    </div>
                </div>
                
                <!-- ÁΩëÁªúÂíåÈí±ÂåÖÈÖçÁΩÆ -->
                <h4 style="margin: 15px 0 10px 0; color: #667eea; font-size: 1em;">ÁΩëÁªú‰∏éÈí±ÂåÖÈÖçÁΩÆ</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="chainId">Âå∫ÂùóÈìæ:</label>
                        <select id="chainId" onchange="updateChainConfig()">
                            <option value="1">‰ª•Â§™Âùä (1)</option>
                            <option value="8453">Base (8453)</option>
                            <option value="56">BSC (56)</option>
                            <option value="137">Polygon (137)</option>
                            <option value="42161">Arbitrum (42161)</option>
                            <option value="10">Optimism (10)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rpcUrl">RPC URL:</label>
                        <input type="text" id="rpcUrl" placeholder="https://eth-mainnet.alchemyapi.io/v2/your_key" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="walletAddress">Èí±ÂåÖÂú∞ÂùÄ:</label>
                        <input type="text" id="walletAddress" placeholder="0x742d35Cc..." />
                    </div>
                    <div class="form-group">
                        <label for="privateKey">ÁßÅÈí•:</label>
                        <input type="password" id="privateKey" placeholder="ÁßÅÈí• (‰∏çÂê´0x)" />
                    </div>
                </div>
                
                <button class="btn" onclick="setConfigWithSave()">ËÆæÁΩÆÈÖçÁΩÆ</button>
                <div id="validateResult" class="result"></div>
                <div id="configResult" class="result"></div>
            </div>

            <!-- Ë¥¶Êà∑‰ø°ÊÅØ -->
            <div class="section">
                <h3>üìä Ë¥¶Êà∑‰ø°ÊÅØ</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>ËøûÊé•Áä∂ÊÄÅ:</label>
                        <span id="connectionStatus" class="status disconnected">Êú™ËøûÊé•</span>
                    </div>
                    <div class="info-item">
                        <label>ETH ‰ΩôÈ¢ù:</label>
                        <span id="ethBalance">--</span>
                    </div>
                </div>
                <div class="info-item" style="margin-bottom: 15px;">
                    <label>Èí±ÂåÖÂú∞ÂùÄ:</label>
                    <span id="currentAddress" style="font-family: monospace; font-size: 0.8em; word-break: break-all;">Êú™ËÆæÁΩÆ</span>
                </div>
                <button class="btn" onclick="loadAccountInfo()">Âà∑Êñ∞Ë¥¶Êà∑‰ø°ÊÅØ</button>
            </div>

            <!-- ‰ª£Â∏Å‰∫§Êç¢ -->
            <div class="section">
                <h3>üí∞ ‰ª£Â∏Å‰∫§Êç¢</h3>
                
                <!-- Âø´Êç∑‰ª£Â∏ÅÈÄâÊã© -->
                <div style="margin-bottom: 15px;">
                    <label style="margin-bottom: 8px;">Âø´Êç∑ÈÄâÊã©‰ª£Â∏Å:</label>
                    <div class="token-buttons" id="tokenButtons">
                        <button class="token-btn" onclick="selectToken('from', '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE')">ETH</button>
                        <button class="token-btn" onclick="selectToken('from', '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48')">USDC</button>
                        <button class="token-btn" onclick="selectToken('from', '0xdAC17F958D2ee523a2206206994597C13D831ec7')">USDT</button>
                        <button class="token-btn" onclick="selectToken('from', '0x6B175474E89094C44Da98b954EedeAC495271d0F')">DAI</button>
                    </div>
                </div>

                <!-- ‰ª£Â∏ÅÈÄâÊã© -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="fromToken">‰ªé‰ª£Â∏ÅÂú∞ÂùÄ:</label>
                        <input type="text" id="fromToken" placeholder="0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE" 
                               oninput="debounceGetTokenInfo('from')" />
                        <div id="fromTokenInfo" class="token-info"></div>
                    </div>
                    <div class="form-group">
                        <label for="toToken">Âà∞‰ª£Â∏ÅÂú∞ÂùÄ:</label>
                        <input type="text" id="toToken" placeholder="0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48" 
                               oninput="debounceGetTokenInfo('to')" />
                        <div id="toTokenInfo" class="token-info"></div>
                    </div>
                </div>
                
                <!-- ‰∫§Êç¢ÂèÇÊï∞ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">‰∫§Êç¢Êï∞Èáè:</label>
                        <div class="amount-input-group">
                            <input type="text" id="amount" placeholder="1.0" oninput="updateAmountConversion()" />
                            <select id="amountUnit" onchange="updateAmountConversion()">
                                <option value="ether">‰ª£Â∏ÅÂçï‰Ωç</option>
                                <option value="wei">WeiÂçï‰Ωç</option>
                            </select>
                        </div>
                        <div id="amountConversion" class="conversion-text"></div>
                    </div>
                    <div class="form-group">
                        <label for="slippage">ÊªëÁÇπÂÆπÂøçÂ∫¶ (%):</label>
                        <input type="text" id="slippage" value="0.5" placeholder="0.5" />
                    </div>
                </div>
                
                <!-- Êìç‰ΩúÊåâÈíÆ -->
                <div class="btn-group">
                    <button class="btn" onclick="getQuote()">Ëé∑ÂèñÊä•‰ª∑</button>
                    <button class="btn" onclick="approveToken()" style="background: linear-gradient(45deg, #ff9500, #ff6b6b);">ÊéàÊùÉ‰ª£Â∏Å</button>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="executeSwap()">ÊâßË°å‰∫§Êç¢</button>
                </div>
                
                <!-- ÁªìÊûúÊòæÁ§∫ -->
                <div id="quoteResult" class="result"></div>
                <div id="approveResult" class="result"></div>
                <div id="swapResult" class="result"></div>
            </div>

            <!-- ‰∫§ÊòìËøΩË∏™ -->
            <div class="section">
                <h3>üîç ‰∫§ÊòìËøΩË∏™</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="orderId">ËÆ¢ÂçïIDÊàñ‰∫§ÊòìÂìàÂ∏å:</label>
                        <input type="text" id="orderId" placeholder="ËæìÂÖ•ËÆ¢ÂçïIDÊàñ‰∫§ÊòìÂìàÂ∏å" />
                    </div>
                </div>
                <button class="btn" onclick="trackTransaction()">ËøΩË∏™‰∫§ÊòìÁä∂ÊÄÅ</button>
                <div id="trackResult" class="result"></div>
            </div>
        </div>

        <!-- ‰øùÂ≠òÂØÜÁ†ÅÂØπËØùÊ°Ü -->
        <div id="savePasswordDialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h4>üîê ËÆæÁΩÆ‰øùÂ≠òÂØÜÁ†Å</h4>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                    ËÆæÁΩÆÂØÜÁ†ÅÊù•Âä†ÂØÜ‰øùÂ≠òÈÖçÁΩÆ‰ø°ÊÅØÔºö
                </p>
                
                <div class="form-group">
                    <label for="savePassword">‰øùÂ≠òÂØÜÁ†Å:</label>
                    <input type="password" id="savePassword" placeholder="ËÆæÁΩÆÂº∫ÂØÜÁ†ÅÔºàËá≥Â∞ë8‰ΩçÔºâ" 
                           onkeypress="if(event.key==='Enter') confirmSaveConfig()" />
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Á°ÆËÆ§ÂØÜÁ†Å:</label>
                    <input type="password" id="confirmPassword" placeholder="ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å" 
                           onkeypress="if(event.key==='Enter') confirmSaveConfig()" />
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="confirmSaveConfig()" style="background: #28a745;">üíæ ‰øùÂ≠ò</button>
                    <button class="btn" onclick="closeSavePasswordDialog()" style="background: #6c757d;">ÂèñÊ∂à</button>
                </div>
                
                <div id="savePasswordResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        // Âä†ÂØÜËß£ÂØÜÂ∑•ÂÖ∑Á±ª
        class CryptoUtils {
            // ‰ΩøÁî®PBKDF2‰ªéÂØÜÁ†ÅÁîüÊàêÂØÜÈí•
            static async deriveKey(password, salt) {
                const encoder = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                return window.crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode(salt),
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
            }
            
            // Âä†ÂØÜÊï∞ÊçÆ
            static async encrypt(data, password) {
                try {
                    const encoder = new TextEncoder();
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    
                    const key = await this.deriveKey(password, salt);
                    const encrypted = await window.crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encoder.encode(JSON.stringify(data))
                    );
                    
                    // Â∞Üsalt„ÄÅivÂíåÂä†ÂØÜÊï∞ÊçÆÁªÑÂêà
                    const result = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                    result.set(salt, 0);
                    result.set(iv, salt.length);
                    result.set(new Uint8Array(encrypted), salt.length + iv.length);
                    
                    return btoa(String.fromCharCode(...result));
                } catch (error) {
                    throw new Error('Âä†ÂØÜÂ§±Ë¥•: ' + error.message);
                }
            }
            
            // Ëß£ÂØÜÊï∞ÊçÆ
            static async decrypt(encryptedData, password) {
                try {
                    const data = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
                    
                    const salt = data.slice(0, 16);
                    const iv = data.slice(16, 28);
                    const encrypted = data.slice(28);
                    
                    const key = await this.deriveKey(password, salt);
                    const decrypted = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encrypted
                    );
                    
                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decrypted));
                } catch (error) {
                    throw new Error('Ëß£ÂØÜÂ§±Ë¥•: ÂØÜÁ†ÅÈîôËØØÊàñÊï∞ÊçÆÊçüÂùè');
                }
            }
        }

        // ÈÖçÁΩÆÁÆ°ÁêÜÁ±ª
        class ConfigManager {
            static STORAGE_KEY = 'okx_dex_encrypted_config';
            static isUnlocked = false;
            static currentConfig = null;
            
            // ‰øùÂ≠òÂä†ÂØÜÈÖçÁΩÆ
            static async saveEncryptedConfig(config, password) {
                try {
                    // ËøáÊª§ÊïèÊÑü‰ø°ÊÅØ
                    const sensitiveConfig = {
                        okxApiKey: config.okxApiKey,
                        okxSecretKey: config.okxSecretKey,
                        okxPassphrase: config.okxPassphrase,
                        okxProjectId: config.okxProjectId,
                        privateKey: config.privateKey,
                        walletAddress: config.walletAddress,
                        rpcUrl: config.rpcUrl,
                        chainId: config.chainId,
                        savedAt: new Date().toISOString()
                    };
                    
                    const encrypted = await CryptoUtils.encrypt(sensitiveConfig, password);
                    localStorage.setItem(this.STORAGE_KEY, encrypted);
                    return true;
                } catch (error) {
                    console.error('‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•:', error);
                    return false;
                }
            }
            
            // Âä†ËΩΩÂπ∂Ëß£ÂØÜÈÖçÁΩÆ
            static async loadEncryptedConfig(password) {
                try {
                    const encrypted = localStorage.getItem(this.STORAGE_KEY);
                    if (!encrypted) {
                        throw new Error('Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑÈÖçÁΩÆ');
                    }
                    
                    const config = await CryptoUtils.decrypt(encrypted, password);
                    this.isUnlocked = true;
                    this.currentConfig = config;
                    return config;
                } catch (error) {
                    this.isUnlocked = false;
                    this.currentConfig = null;
                    throw error;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑÈÖçÁΩÆ
            static hasEncryptedConfig() {
                return localStorage.getItem(this.STORAGE_KEY) !== null;
            }
            
            // Âà†Èô§‰øùÂ≠òÁöÑÈÖçÁΩÆ
            static clearEncryptedConfig() {
                localStorage.removeItem(this.STORAGE_KEY);
                this.isUnlocked = false;
                this.currentConfig = null;
            }
            
            // ÈîÅÂÆöÈÖçÁΩÆ
            static lock() {
                this.isUnlocked = false;
                this.currentConfig = null;
                // Ê∏ÖÁ©∫Ë°®Âçï
                this.clearForm();
                // ÊòæÁ§∫Ëß£ÈîÅÁïåÈù¢
                this.showUnlockInterface();
            }
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            static clearForm() {
                ['okxApiKey', 'okxSecretKey', 'okxPassphrase', 'okxProjectId', 
                 'privateKey', 'walletAddress', 'rpcUrl'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = '';
                });
            }
            
            // Â°´ÂÖÖË°®Âçï
            static fillForm(config) {
                Object.keys(config).forEach(key => {
                    const element = document.getElementById(key);
                    if (element && config[key]) {
                        element.value = config[key];
                    }
                });
                
                // Êõ¥Êñ∞ÈìæÈÖçÁΩÆ
                if (config.chainId) {
                    document.getElementById('chainId').value = config.chainId;
                    updateChainConfig();
                }
            }
            
            // ÊòæÁ§∫Ëß£ÈîÅÁïåÈù¢
            static showUnlockInterface() {
                const hasConfig = this.hasEncryptedConfig();
                const unlockSection = document.getElementById('unlockSection');
                const configSection = document.getElementById('configSection');
                
                if (hasConfig) {
                    unlockSection.style.display = 'block';
                    configSection.style.display = 'none';
                } else {
                    unlockSection.style.display = 'none';
                    configSection.style.display = 'block';
                }
            }
            
            // ÊòæÁ§∫ÈÖçÁΩÆÁïåÈù¢
            static showConfigInterface() {
                const unlockSection = document.getElementById('unlockSection');
                const configSection = document.getElementById('configSection');
                
                unlockSection.style.display = 'none';
                configSection.style.display = 'block';
            }
        }

        // Èò≤ÊäñÂÆöÊó∂Âô®
        let tokenInfoTimeouts = {};

        // Âø´ÈÄüÈÄâÊã©‰ª£Â∏Å
        function selectToken(type, address) {
            const inputId = type === 'from' ? 'fromToken' : 'toToken';
            document.getElementById(inputId).value = address;
            getTokenInfo(type, address);
        }

        // Èò≤ÊäñËé∑Âèñ‰ª£Â∏Å‰ø°ÊÅØ
        function debounceGetTokenInfo(type) {
            const address = document.getElementById(type === 'from' ? 'fromToken' : 'toToken').value;
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            if (tokenInfoTimeouts[type]) {
                clearTimeout(tokenInfoTimeouts[type]);
            }
            
            // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®
            tokenInfoTimeouts[type] = setTimeout(() => {
                if (address && address.length >= 42) {
                    getTokenInfo(type, address);
                } else {
                    hideTokenInfo(type);
                }
            }, 500);
        }

        // Ëé∑Âèñ‰ª£Â∏Å‰ø°ÊÅØ
        async function getTokenInfo(type, address) {
            const infoId = type === 'from' ? 'fromTokenInfo' : 'toTokenInfo';
            const infoElement = document.getElementById(infoId);
            
            if (!address || address.length < 42) {
                hideTokenInfo(type);
                return;
            }
            
            try {
                infoElement.className = 'token-info show';
                infoElement.innerHTML = '<span class="loading"></span>Ëé∑Âèñ‰ª£Â∏Å‰ø°ÊÅØ‰∏≠...';
                
                const result = await apiCall(`/api/token-info/${address}`);
                
                if (result.success) {
                    infoElement.className = 'token-info show success';
                    infoElement.innerHTML = `
                        <strong>${result.data.symbol}</strong> - ${result.data.name}<br>
                        <small>Á≤æÂ∫¶: ${result.data.decimals} ‰Ωç</small>
                    `;
                } else {
                    infoElement.className = 'token-info show error';
                    infoElement.innerHTML = `‚ùå ${result.message}`;
                }
            } catch (error) {
                infoElement.className = 'token-info show error';
                infoElement.innerHTML = `‚ùå Ëé∑Âèñ‰ª£Â∏Å‰ø°ÊÅØÂ§±Ë¥•: ${error.message}`;
            }
        }

        // ÈöêËóè‰ª£Â∏Å‰ø°ÊÅØ
        function hideTokenInfo(type) {
            const infoId = type === 'from' ? 'fromTokenInfo' : 'toTokenInfo';
            const infoElement = document.getElementById(infoId);
            if (infoElement) {
                infoElement.className = 'token-info';
                infoElement.innerHTML = '';
            }
        }

        // Êõ¥Êñ∞Êï∞ÈáèÂä©Êâã - ÁßªÈô§ÁâàÊú¨ÔºåÈÅøÂÖçËÆøÈóÆ‰∏çÂ≠òÂú®ÁöÑÂÖÉÁ¥†
        function updateAmountHelper(type, tokenData) {
            // ‰∏çÂÜçÊòæÁ§∫Êï∞ÈáèÂä©ÊâãÔºåÁÆÄÂåñÁïåÈù¢
            return;
        }

        // API Ë∞ÉÁî®ÂáΩÊï∞
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(endpoint, options);
                return await response.json();
            } catch (error) {
                return {
                    success: false,
                    message: error.message
                };
            }
        }

        // ÊòæÁ§∫ÁªìÊûú - ‰ºòÂåñÁâàÊú¨
        function showResult(elementId, result, isSuccess = null) {
            const element = document.getElementById(elementId);
            const success = isSuccess !== null ? isSuccess : result.success;
            
            element.className = `result ${success ? 'success' : 'error'}`;
            element.style.display = 'block';
            
            if (typeof result === 'object') {
                let displayContent = '';
                
                if (!success && result.message) {
                    // ÁÆÄÂåñÈîôËØØ‰ø°ÊÅØÊòæÁ§∫ - ÊîπËøõÁâàÊú¨
                    if (result.message.includes('ËØ∑ÂÖàÈÖçÁΩÆ') || result.message.includes('ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ')) {
                        displayContent = `‚ö†Ô∏è ËØ∑ÂÖàÂÆåÊàêÈÖçÁΩÆËÆæÁΩÆ - Â°´ÂÜôÂπ∂‰øùÂ≠òOKX APIÂíåÈí±ÂåÖÈÖçÁΩÆ‰ø°ÊÅØ`;
                    } else if (result.message.includes('status code 401') || result.message.includes('APIËÆ§ËØÅÂ§±Ë¥•')) {
                        displayContent = `‚ùå APIËÆ§ËØÅÂ§±Ë¥• - ËØ∑Ê£ÄÊü•OKX APIÈÖçÁΩÆ‰ø°ÊÅØÊòØÂê¶Ê≠£Á°Æ`;
                    } else if (result.message.includes('Insufficient liquidity')) {
                        displayContent = `‚ö†Ô∏è ÊµÅÂä®ÊÄß‰∏çË∂≥ - ËØ∑Â∞ùËØïÂáèÂ∞ë‰∫§Êç¢Êï∞ÈáèÊàñÊõ¥Êç¢‰ª£Â∏ÅÂØπ`;
                    } else if (result.message.includes('ÁΩëÁªúËøûÊé•') || result.message.includes('ECONNREFUSED')) {
                        displayContent = `‚ùå ÁΩëÁªúËøûÊé•Â§±Ë¥• - ËØ∑Ê£ÄÊü•RPC URLÈÖçÁΩÆ`;
                    } else if (result.message.includes('Áº∫Â∞ëÂøÖÈúÄÁöÑÂèÇÊï∞')) {
                        displayContent = `‚ùå ÂèÇÊï∞ÈîôËØØ - ËØ∑Ê£ÄÊü•‰ª£Â∏ÅÂú∞ÂùÄÂíåÊï∞ÈáèÊòØÂê¶Ê≠£Á°ÆÂ°´ÂÜô`;
                    } else {
                        displayContent = `‚ùå ${result.message}`;
                    }
                } else if (success && result.data) {
                    // ÊîπËøõÊàêÂäü‰ø°ÊÅØÊòæÁ§∫
                    if (elementId === 'quoteResult') {
                        displayContent = formatQuoteResult(result.data);
                    } else if (elementId === 'swapResult') {
                        displayContent = formatSwapResult(result.data);
                    } else if (elementId === 'approveResult') {
                        displayContent = formatApprovalResult(result.data);
                    } else if (elementId === 'validateResult') {
                        displayContent = `‚úÖ APIÈÖçÁΩÆÈ™åËØÅÊàêÂäü`;
                    } else if (elementId === 'configResult') {
                        displayContent = `‚úÖ ÈÖçÁΩÆËÆæÁΩÆÊàêÂäü`;
                    } else {
                        displayContent = `‚úÖ Êìç‰ΩúÊàêÂäü`;
                    }
                } else {
                    // ÊòæÁ§∫ÂéüÂßãÊï∞ÊçÆÁî®‰∫éË∞ÉËØï
                    displayContent = `<pre style="max-height: 150px; overflow-y: auto; font-size: 0.8em;">${JSON.stringify(result, null, 2)}</pre>`;
                }
                
                element.innerHTML = displayContent;
            } else {
                element.textContent = result;
            }
        }

        // Ê†ºÂºèÂåñÊä•‰ª∑ÁªìÊûú
        function formatQuoteResult(data) {
            console.log('ÂâçÁ´ØÊé•Êî∂Âà∞ÁöÑÊä•‰ª∑Êï∞ÊçÆ:', data); // Ë∞ÉËØïÊó•Âøó
            
            // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑ - ÈÄÇÈÖçÂêéÁ´ØËøîÂõûÁöÑÊ†ºÂºè
            if (!data) {
                return '‚ùå Êú™Ëé∑ÂèñÂà∞Êä•‰ª∑Êï∞ÊçÆ';
            }

            // ‰ªéËøîÂõûÁöÑÊï∞ÊçÆ‰∏≠ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ - ‰øÆÊ≠£Êï∞ÊçÆË∑ØÂæÑ
            let fromToken, toToken, fromTokenAmount, toTokenAmount, estimatedGas, priceImpact;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúârouterResultÔºàÊñ∞Ê†ºÂºèÔºâ
            if (data.routerResult) {
                fromToken = data.routerResult.fromToken;
                toToken = data.routerResult.toToken;
                fromTokenAmount = data.routerResult.fromTokenAmount;
                toTokenAmount = data.routerResult.toTokenAmount;
                estimatedGas = data.routerResult.estimateGasFee || '0';
                priceImpact = data.routerResult.priceImpactPercentage || '0';
            } else {
                // ÂÖºÂÆπÊóßÊ†ºÂºè
                fromToken = data.fromToken;
                toToken = data.toToken;
                fromTokenAmount = data.fromTokenAmount;
                toTokenAmount = data.toTokenAmount;
                estimatedGas = data.estimateGasFee || '0';
                priceImpact = data.priceImpactPercentage || '0';
            }

            if (!fromToken || !toToken) {
                return '‚ùå Êä•‰ª∑Êï∞ÊçÆÊ†ºÂºèÈîôËØØÔºöÁº∫Â∞ë‰ª£Â∏Å‰ø°ÊÅØ';
            }
            
            // ËÆ°ÁÆóÊï∞ÈáèÔºà‰ªéweiËΩ¨Êç¢‰∏∫‰ª£Â∏ÅÂçï‰ΩçÔºâ
            const fromAmount = fromTokenAmount ? (parseFloat(fromTokenAmount) / Math.pow(10, parseInt(fromToken.decimal || 18))).toFixed(6) : '0';
            const toAmount = toTokenAmount ? (parseFloat(toTokenAmount) / Math.pow(10, parseInt(toToken.decimal || 18))).toFixed(6) : '0';
            
            // ËÆ°ÁÆó‰ª∑Ê†ºÊØîÁéá
            const fromAmountNum = parseFloat(fromAmount);
            const toAmountNum = parseFloat(toAmount);
            const price = fromAmountNum > 0 ? (toAmountNum / fromAmountNum).toFixed(6) : '0';
            
            // ÊòæÁ§∫DEXË∑ØÁî±‰ø°ÊÅØ
            let routeInfo = '';
            const dexRouterList = data.routerResult?.dexRouterList || data.dexRouterList;
            if (dexRouterList && dexRouterList.length > 0) {
                const route = dexRouterList[0];
                if (route.subRouterList && route.subRouterList[0] && route.subRouterList[0].dexProtocol) {
                    const dexName = route.subRouterList[0].dexProtocol[0]?.dexName || 'Êú™Áü•DEX';
                    routeInfo = `<div style="font-size: 0.75em; color: #666; margin-top: 4px;">ÈÄöËøá ${dexName} Ë∑ØÁî±</div>`;
                }
            }
            
            // ÊòæÁ§∫Â§ö‰∏™DEXÊØîËæÉ‰ø°ÊÅØ
            let compareInfo = '';
            const quoteCompareList = data.routerResult?.quoteCompareList || data.quoteCompareList;
            if (quoteCompareList && quoteCompareList.length > 1) {
                compareInfo = `<div style="font-size: 0.75em; color: #666; margin-top: 4px;">ÊØîËæÉ‰∫Ü ${quoteCompareList.length} ‰∏™DEXÔºåÈÄâÊã©ÊúÄ‰ºòË∑ØÁî±</div>`;
            }
            
            return `
                <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 8px; margin: 4px 0; font-size: 0.85em;">
                    <div style="font-weight: bold; color: #2e7d32; margin-bottom: 6px;">üí∞ BSCÈìæÊä•‰ª∑ÁªìÊûú</div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span>ÊîØ‰ªò: <strong>${fromAmount} ${fromToken.tokenSymbol}</strong></span>
                        <span style="color: #4caf50; margin: 0 8px;">‚Üí</span>
                        <span>Ëé∑Âæó: <strong style="color: #2e7d32;">${toAmount} ${toToken.tokenSymbol}</strong></span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 4px;">
                        <span>‰ª∑Ê†º: 1 ${fromToken.tokenSymbol} = ${price} ${toToken.tokenSymbol}</span>
                        <span>‰ª∑Ê†ºÂΩ±Âìç: ${priceImpact}%</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #888; margin-top: 2px;">
                        <span>È¢Ñ‰º∞Gas: ${formatGasFee(estimatedGas)}</span>
                        <span>ÊªëÁÇπÂÆπÂøç: ${data.slippage || '0.5'}%</span>
                    </div>
                    
                    ${routeInfo}
                    ${compareInfo}
                </div>
            `;
        }

        // Ê†ºÂºèÂåñ‰ª£Â∏ÅÊï∞ÈáèÊòæÁ§∫
        function formatTokenAmount(amount, symbol) {
            if (!amount || amount === 0) return '0';
            
            const num = Number(amount);
            if (num >= 1e9) {
                return `${(num / 1e9).toFixed(2)}B ${symbol}`;
            } else if (num >= 1e6) {
                return `${(num / 1e6).toFixed(2)}M ${symbol}`;
            } else if (num >= 1e3) {
                return `${(num / 1e3).toFixed(2)}K ${symbol}`;
            } else if (num >= 1) {
                return `${num.toFixed(4)} ${symbol}`;
            } else {
                return `${num.toExponential(2)} ${symbol}`;
            }
        }

        // Ê†ºÂºèÂåñGasË¥πÊòæÁ§∫
        function formatGasFee(gasFee) {
            const num = Number(gasFee);
            if (num === 0) return '0 BNB';
            
            const bnbValue = num / 1e18;
            if (bnbValue >= 0.01) {
                return `${bnbValue.toFixed(4)} BNB`;
            } else {
                return `${bnbValue.toExponential(2)} BNB`;
            }
        }

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        function setLoading(buttonElement, loading = true) {
            if (loading) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<span class="loading"></span>Â§ÑÁêÜ‰∏≠...';
            } else {
                buttonElement.disabled = false;
                buttonElement.innerHTML = buttonElement.getAttribute('data-original-text') || 'ÊâßË°å';
            }
        }

        // ËÆæÁΩÆÈÖçÁΩÆ
        async function setConfig() {
            const okxApiKey = document.getElementById('okxApiKey').value;
            const okxSecretKey = document.getElementById('okxSecretKey').value;
            const okxPassphrase = document.getElementById('okxPassphrase').value;
            const okxProjectId = document.getElementById('okxProjectId').value;
            const rpcUrl = document.getElementById('rpcUrl').value;
            const chainId = document.getElementById('chainId').value;
            const walletAddress = document.getElementById('walletAddress').value;
            const privateKey = document.getElementById('privateKey').value;
            const btn = document.querySelector('button[onclick="setConfigWithSave()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }
            
            if (!okxApiKey || !okxSecretKey || !okxPassphrase || !okxProjectId || !rpcUrl || !chainId || !walletAddress || !privateKey) {
                showResult('configResult', { success: false, message: 'ËØ∑Â°´ÂÜôÊâÄÊúâÈÖçÁΩÆÈ°π' }, false);
                return;
            }

            setLoading(btn);
            
            const result = await apiCall('/api/config', 'POST', {
                okxApiKey,
                okxSecretKey,
                okxPassphrase,
                okxProjectId,
                rpcUrl,
                chainId,
                walletAddress,
                privateKey
            });

            setLoading(btn, false);
            showResult('configResult', result);
            
            if (result.success) {
                loadAccountInfo();
            }
        }

        // ‰øÆÊîπÂéüÊúâÁöÑsetConfigÂáΩÊï∞ÔºåÊ∑ªÂä†‰øùÂ≠òÊèêÁ§∫
        async function setConfigWithSave() {
            // ÂÖàÊâßË°åÂéüÊúâÁöÑËÆæÁΩÆÈÖçÁΩÆÈÄªËæë
            await setConfig();
            
            // Â¶ÇÊûúÈÖçÁΩÆÊàêÂäü‰∏îÊú™Ëß£ÈîÅÁä∂ÊÄÅÔºåÊèêÁ§∫‰øùÂ≠ò
            if (!ConfigManager.isUnlocked) {
                const result = document.getElementById('configResult');
                if (result.classList.contains('success')) {
                    setTimeout(() => {
                        if (confirm('ÈÖçÁΩÆËÆæÁΩÆÊàêÂäüÔºÅÊòØÂê¶Ë¶ÅÂä†ÂØÜ‰øùÂ≠òÂà∞Êú¨Âú∞Ôºå‰ª•‰æø‰∏ãÊ¨°Âø´ÈÄü‰ΩøÁî®Ôºü')) {
                            showSavePasswordDialog();
                        }
                    }, 1000);
                }
            }
        }

        // ÈáëÈ¢ùËΩ¨Êç¢Â∑•ÂÖ∑ÂáΩÊï∞
        function parseUnits(value, decimals = 18) {
            if (!value || isNaN(value)) return '0';
            
            // Â¶ÇÊûúÂ∞èÊï∞‰ΩçÊï∞Â§ß‰∫é‰ª£Â∏ÅÁ≤æÂ∫¶ÔºåÊà™Êñ≠
            const parts = value.toString().split('.');
            if (parts.length > 1 && parts[1].length > decimals) {
                const truncated = parts[0] + '.' + parts[1].slice(0, decimals);
                value = parseFloat(truncated);
            }
            
            // ËΩ¨Êç¢‰∏∫wei
            const factor = BigInt(10) ** BigInt(decimals);
            const integerPart = BigInt(Math.floor(value));
            const fractionalPart = value - Math.floor(value);
            
            const weiInteger = integerPart * factor;
            const weiFractional = BigInt(Math.round(fractionalPart * Number(factor)));
            
            return (weiInteger + weiFractional).toString();
        }

        function formatUnits(value, decimals = 18) {
            if (!value || value === '0') return '0';
            
            const factor = BigInt(10) ** BigInt(decimals);
            const bigValue = BigInt(value);
            
            const integerPart = bigValue / factor;
            const fractionalPart = bigValue % factor;
            
            const fractionalStr = fractionalPart.toString().padStart(decimals, '0');
            const trimmed = fractionalStr.replace(/0+$/, '');
            
            if (trimmed === '') {
                return integerPart.toString();
            } else {
                return integerPart.toString() + '.' + trimmed;
            }
        }

        // Êõ¥Êñ∞ÈáëÈ¢ùËΩ¨Êç¢ÊòæÁ§∫
        function updateAmountConversion() {
            const amountInput = document.getElementById('amount');
            const unitSelect = document.getElementById('amountUnit');
            const conversionDiv = document.getElementById('amountConversion');
            
            if (!amountInput || !unitSelect || !conversionDiv) return;
            
            const value = amountInput.value;
            const unit = unitSelect.value;
            
            if (!value || isNaN(value) || parseFloat(value) <= 0) {
                conversionDiv.textContent = '';
                return;
            }
            
            if (unit === 'ether') {
                const weiValue = parseUnits(value, 18);
                // ÁÆÄÂåñÊòæÁ§∫ÔºöÂè™ÊòæÁ§∫ÁßëÂ≠¶ËÆ°Êï∞Ê≥ïÊàñËÄÖÁÆÄÂåñÁöÑÊï∞Â≠ó
                const weiNumber = BigInt(weiValue);
                if (weiNumber >= BigInt('1000000000000000000')) {
                    const ethValue = Number(weiNumber) / 1e18;
                    conversionDiv.textContent = `= ${ethValue.toExponential(2)} wei`;
                } else {
                    conversionDiv.textContent = `= ${weiValue} wei`;
                }
            } else {
                const etherValue = formatUnits(value, 18);
                conversionDiv.textContent = `= ${etherValue} ‰ª£Â∏ÅÂçï‰Ωç`;
            }
        }

        // Ëé∑ÂèñÊúÄÁªàÁöÑweiÈáëÈ¢ù
        function getFinalAmount() {
            const amountInput = document.getElementById('amount');
            const unitSelect = document.getElementById('amountUnit');
            
            if (!amountInput || !unitSelect) return '0';
            
            const value = amountInput.value;
            const unit = unitSelect.value;
            
            if (!value || isNaN(value) || parseFloat(value) <= 0) return '0';
            
            if (unit === 'ether') {
                return parseUnits(value, 18);
            } else {
                return value; // Â∑≤ÁªèÊòØwei
            }
        }

        // Âä†ËΩΩË¥¶Êà∑‰ø°ÊÅØ
        async function loadAccountInfo() {
            const result = await apiCall('/api/account');
            
            if (result.success) {
                document.getElementById('connectionStatus').textContent = result.data.connected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•';
                document.getElementById('connectionStatus').className = `status ${result.data.connected ? 'connected' : 'disconnected'}`;
                document.getElementById('ethBalance').textContent = result.data.ethBalance;
                document.getElementById('currentAddress').textContent = result.data.walletAddress;
            }
        }

        // Ê£ÄÊü•ÈÖçÁΩÆÊòØÂê¶Â∑≤ËÆæÁΩÆ
        function checkConfigurationReady() {
            const okxApiKey = document.getElementById('okxApiKey').value;
            const okxSecretKey = document.getElementById('okxSecretKey').value;
            const okxPassphrase = document.getElementById('okxPassphrase').value;
            const okxProjectId = document.getElementById('okxProjectId').value;
            const rpcUrl = document.getElementById('rpcUrl').value;
            const chainId = document.getElementById('chainId').value;
            const walletAddress = document.getElementById('walletAddress').value;
            const privateKey = document.getElementById('privateKey').value;

            if (!okxApiKey || !okxSecretKey || !okxPassphrase || !okxProjectId || 
                !rpcUrl || !chainId || !walletAddress || !privateKey) {
                return false;
            }
            return true;
        }

        // Ëé∑ÂèñÊä•‰ª∑
        async function getQuote() {
            // Ê£ÄÊü•ÈÖçÁΩÆÊòØÂê¶ÂÆåÊï¥
            if (!checkConfigurationReady()) {
                showResult('quoteResult', { 
                    success: false, 
                    message: 'ËØ∑ÂÖàÂÆåÊàêÈÖçÁΩÆËÆæÁΩÆÔºöÂ°´ÂÜôÂÆåÊï¥ÁöÑ OKX API ÈÖçÁΩÆ„ÄÅÁΩëÁªúÈÖçÁΩÆÂíåÈí±ÂåÖ‰ø°ÊÅØÔºåÁÑ∂ÂêéÁÇπÂáª"ËÆæÁΩÆÈÖçÁΩÆ"ÊåâÈíÆ' 
                }, false);
                return;
            }

            const fromTokenAddress = document.getElementById('fromToken').value;
            const toTokenAddress = document.getElementById('toToken').value;
            const amount = getFinalAmount(); // ‰ΩøÁî®ËΩ¨Êç¢ÂêéÁöÑweiÈáëÈ¢ù
            const slippage = document.getElementById('slippage').value;
            const chainId = document.getElementById('chainId').value; // Ëé∑ÂèñÈìæID
            const btn = document.querySelector('button[onclick="getQuote()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!fromTokenAddress || !toTokenAddress) {
                showResult('quoteResult', { success: false, message: 'ËØ∑ÈÄâÊã©Ë¶Å‰∫§Êç¢ÁöÑ‰ª£Â∏Å' }, false);
                return;
            }

            if (!amount || amount === '0') {
                showResult('quoteResult', { success: false, message: 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Èáè' }, false);
                return;
            }

            if (!chainId) {
                showResult('quoteResult', { success: false, message: 'ËØ∑ÈÄâÊã©Âå∫ÂùóÈìæÁΩëÁªú' }, false);
                return;
            }

            setLoading(btn);

            const result = await apiCall('/api/quote', 'POST', {
                fromTokenAddress,
                toTokenAddress,
                amount,
                slippage,
                chainIndex: chainId, // Ê†πÊçÆÂÆòÊñπÊñáÊ°£‰ΩøÁî®chainIndex
                chainId: chainId,    // ‰øùÁïôchainId‰ª•ÂÖºÂÆπ
                userWalletAddress: document.getElementById('walletAddress').value // ÊÅ¢Â§çÂøÖÈúÄÁöÑÂèÇÊï∞
            });

            setLoading(btn, false);
            showResult('quoteResult', result);
        }

        // ÊâßË°å‰∫§Êç¢
        async function executeSwap() {
            // Ê£ÄÊü•ÈÖçÁΩÆÊòØÂê¶ÂÆåÊï¥
            if (!checkConfigurationReady()) {
                showResult('swapResult', { 
                    success: false, 
                    message: 'ËØ∑ÂÖàÂÆåÊàêÈÖçÁΩÆËÆæÁΩÆÔºöÂ°´ÂÜôÂÆåÊï¥ÁöÑ OKX API ÈÖçÁΩÆ„ÄÅÁΩëÁªúÈÖçÁΩÆÂíåÈí±ÂåÖ‰ø°ÊÅØÔºåÁÑ∂ÂêéÁÇπÂáª"ËÆæÁΩÆÈÖçÁΩÆ"ÊåâÈíÆ' 
                }, false);
                return;
            }

            const fromTokenAddress = document.getElementById('fromToken').value;
            const toTokenAddress = document.getElementById('toToken').value;
            const amount = getFinalAmount(); // ‰ΩøÁî®ËΩ¨Êç¢ÂêéÁöÑweiÈáëÈ¢ù
            const slippage = document.getElementById('slippage').value;
            const chainId = document.getElementById('chainId').value; // Ëé∑ÂèñÈìæID
            const btn = document.querySelector('button[onclick="executeSwap()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!amount || amount === '0') {
                showResult('swapResult', { success: false, message: 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Èáè' }, false);
                return;
            }

            if (!chainId) {
                showResult('swapResult', { success: false, message: 'ËØ∑ÈÄâÊã©Âå∫ÂùóÈìæÁΩëÁªú' }, false);
                return;
            }

            if (!confirm('Á°ÆÂÆöË¶ÅÊâßË°å‰∫§Êç¢ÂêóÔºüËøôÂ∞ÜËä±Ë¥πÁúüÂÆûÁöÑ‰ª£Â∏ÅÂíåGasË¥πÁî®„ÄÇ')) {
                return;
            }

            setLoading(btn);

            const result = await apiCall('/api/swap', 'POST', {
                fromTokenAddress,
                toTokenAddress,
                amount,
                slippage,
                chainIndex: chainId, // Ê†πÊçÆÂÆòÊñπÊñáÊ°£‰ΩøÁî®chainIndex
                chainId: chainId,    // ‰øùÁïôchainId‰ª•ÂÖºÂÆπ
                userWalletAddress: document.getElementById('walletAddress').value // ÊÅ¢Â§çÂøÖÈúÄÁöÑÂèÇÊï∞
            });

            setLoading(btn, false);
            showResult('swapResult', result);
            
            // Â¶ÇÊûú‰∫§Êç¢ÊàêÂäüÔºåËá™Âä®Â°´ÂÖÖËÆ¢ÂçïIDÂà∞ËøΩË∏™Ê°Ü
            if (result.success && result.data && result.data.orderId) {
                document.getElementById('orderId').value = result.data.orderId;
            }
        }

        // ‰ª£Â∏ÅÊéàÊùÉ
        async function approveToken() {
            // Ê£ÄÊü•ÈÖçÁΩÆÊòØÂê¶ÂÆåÊï¥
            if (!checkConfigurationReady()) {
                showResult('approveResult', { 
                    success: false, 
                    message: 'ËØ∑ÂÖàÂÆåÊàêÈÖçÁΩÆËÆæÁΩÆÔºöÂ°´ÂÜôÂÆåÊï¥ÁöÑ OKX API ÈÖçÁΩÆ„ÄÅÁΩëÁªúÈÖçÁΩÆÂíåÈí±ÂåÖ‰ø°ÊÅØÔºåÁÑ∂ÂêéÁÇπÂáª"ËÆæÁΩÆÈÖçÁΩÆ"ÊåâÈíÆ' 
                }, false);
                return;
            }

            const fromTokenAddress = document.getElementById('fromToken').value;
            const amount = getFinalAmount(); // ‰ΩøÁî®ËΩ¨Êç¢ÂêéÁöÑweiÈáëÈ¢ù
            const btn = document.querySelector('button[onclick="approveToken()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!fromTokenAddress) {
                showResult('approveResult', { success: false, message: 'ËØ∑ÈÄâÊã©Ë¶ÅÊéàÊùÉÁöÑ‰ª£Â∏Å' }, false);
                return;
            }

            // ETH‰∏çÈúÄË¶ÅÊéàÊùÉ
            if (fromTokenAddress.toLowerCase() === '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee') {
                showResult('approveResult', { success: false, message: 'ETH ‰∏çÈúÄË¶ÅÊéàÊùÉÔºåÂèØ‰ª•Áõ¥Êé•‰∫§Êç¢' }, false);
                return;
            }

            if (!amount || amount === '0') {
                showResult('approveResult', { success: false, message: 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊéàÊùÉÊï∞Èáè' }, false);
                return;
            }

            if (!confirm('Á°ÆÂÆöË¶ÅÊéàÊùÉ‰ª£Â∏ÅÂêóÔºüËøôÂ∞ÜËä±Ë¥πÂ∞ëÈáèGasË¥πÁî®„ÄÇ')) {
                return;
            }

            setLoading(btn);

            const result = await apiCall('/api/approve', 'POST', {
                tokenAddress: fromTokenAddress,
                amount: amount
            });

            setLoading(btn, false);
            showResult('approveResult', result);
        }

        // ËøΩË∏™‰∫§Êòì
        async function trackTransaction() {
            const orderId = document.getElementById('orderId').value;
            const btn = document.querySelector('button[onclick="trackTransaction()"]');
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }

            if (!orderId) {
                showResult('trackResult', { success: false, message: 'ËØ∑ËæìÂÖ•ËÆ¢ÂçïID' }, false);
                return;
            }

            setLoading(btn);

            const result = await apiCall(`/api/track/${orderId}`);

            setLoading(btn, false);
            showResult('trackResult', result);
        }

        // È°µÈù¢ÂàùÂßãÂåñ
        function initializePage() {
            // ‰øùÂ≠òÂéüÂßãplaceholder
            const amountInput = document.getElementById('amount');
            if (amountInput && !amountInput.getAttribute('data-original-placeholder')) {
                amountInput.setAttribute('data-original-placeholder', amountInput.placeholder);
            }
            
            // ËÆæÁΩÆÂàùÂßãÈìæÈÖçÁΩÆ
            updateChainConfig();
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂä†ÂØÜÈÖçÁΩÆ
            ConfigManager.showUnlockInterface();
            
            // Â¶ÇÊûúÊ≤°ÊúâÂä†ÂØÜÈÖçÁΩÆÔºåÂ∞ùËØïÂä†ËΩΩ‰º†ÁªüÁöÑË¥¶Êà∑‰ø°ÊÅØ
            if (!ConfigManager.hasEncryptedConfig()) {
                loadAccountInfo();
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // ÈìæÈÖçÁΩÆ‰ø°ÊÅØ
        const CHAIN_CONFIG = {
            '1': {
                name: '‰ª•Â§™Âùä‰∏ªÁΩë',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://eth-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48' },
                    { symbol: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7' },
                    { symbol: 'DAI', address: '0x6B175474E89094C44Da98b954EedeAC495271d0F' },
                    { symbol: 'WETH', address: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2' }
                ]
            },
            '56': {
                name: 'BSC',
                nativeToken: {
                    symbol: 'BNB',
                    name: 'BNB',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://bsc-dataseed.binance.org/',
                commonTokens: [
                    { symbol: 'USDT', address: '0x55d398326f99059fF775485246999027B3197955' },
                    { symbol: 'WBNB', address: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c' },
                    { symbol: 'USDC', address: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d' },
                    { symbol: 'BUSD', address: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56' }
                ]
            },
            '137': {
                name: 'Polygon',
                nativeToken: {
                    symbol: 'MATIC',
                    name: 'Polygon',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://polygon-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174' },
                    { symbol: 'USDT', address: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F' },
                    { symbol: 'WMATIC', address: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270' },
                    { symbol: 'WETH', address: '0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619' }
                ]
            },
            '8453': {
                name: 'Base',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://base-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913' },
                    { symbol: 'USDT', address: '0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2' },
                    { symbol: 'DAI', address: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb' },
                    { symbol: 'WETH', address: '0x4200000000000000000000000000000000000006' }
                ]
            },
            '42161': {
                name: 'Arbitrum',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://arb-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831' },
                    { symbol: 'USDT', address: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9' },
                    { symbol: 'DAI', address: '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1' },
                    { symbol: 'WETH', address: '0x82aF49447D8a07e3bd95BD0d56f35241523fBab1' }
                ]
            },
            '10': {
                name: 'Optimism',
                nativeToken: {
                    symbol: 'ETH',
                    name: 'Ethereum',
                    address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE',
                    decimals: 18
                },
                rpcUrl: 'https://opt-mainnet.alchemyapi.io/v2/your_key',
                commonTokens: [
                    { symbol: 'USDC', address: '0x7F5c764cBc14f9669B88837ca1490cCa17c31607' },
                    { symbol: 'USDT', address: '0x94b008aA00579c1307B0EF2c499aD98a8ce58e58' },
                    { symbol: 'DAI', address: '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1' },
                    { symbol: 'WETH', address: '0x4200000000000000000000000000000000000006' }
                ]
            }
        };

        // ÂΩìÂâçÈÄâÊã©ÁöÑÈìæID
        let currentChainId = '1';

        // Êõ¥Êñ∞ÈìæÈÖçÁΩÆ
        function updateChainConfig() {
            const chainId = document.getElementById('chainId').value;
            const rpcUrlInput = document.getElementById('rpcUrl');
            
            currentChainId = chainId;
            const chainConfig = CHAIN_CONFIG[chainId];
            
            if (chainConfig && !rpcUrlInput.value.includes('your_key')) {
                // Âè™ÊúâÂΩìÁî®Êà∑Ê≤°ÊúâËá™ÂÆö‰πâRPCÊó∂ÊâçÊõ¥Êñ∞
                if (chainConfig.rpcUrl.includes('your_key')) {
                    rpcUrlInput.placeholder = `ËØ∑ËæìÂÖ• ${chainConfig.name} ÁöÑ RPC URL`;
                } else {
                    rpcUrlInput.value = chainConfig.rpcUrl;
                }
            }
            
            // Êõ¥Êñ∞Âø´Êç∑‰ª£Â∏ÅÊåâÈíÆ
            updateNativeTokenButton(chainConfig);
            
            // Êõ¥Êñ∞Á§∫‰æãÊòæÁ§∫
            updateExamples(chainConfig);
        }

        // Êõ¥Êñ∞ÂéüÁîü‰ª£Â∏ÅÊåâÈíÆ
        function updateNativeTokenButton(chainConfig) {
            const tokenButtons = document.querySelector('.token-buttons');
            if (tokenButtons && chainConfig) {
                // Ê∏ÖÁ©∫Áé∞ÊúâÊåâÈíÆ
                tokenButtons.innerHTML = '';
                
                // Ê∑ªÂä†ÂéüÁîü‰ª£Â∏ÅÊåâÈíÆ
                const nativeButton = document.createElement('button');
                nativeButton.className = 'token-btn native-token-btn';
                nativeButton.textContent = chainConfig.nativeToken.symbol;
                nativeButton.onclick = () => selectToken('from', chainConfig.nativeToken.address);
                tokenButtons.appendChild(nativeButton);
                
                // Ê∑ªÂä†Â∏∏Áî®‰ª£Â∏ÅÊåâÈíÆ
                chainConfig.commonTokens.forEach(token => {
                    const button = document.createElement('button');
                    button.className = 'token-btn';
                    button.textContent = token.symbol;
                    button.onclick = () => selectToken('from', token.address);
                    tokenButtons.appendChild(button);
                });
            }
        }

        // Êõ¥Êñ∞Á§∫‰æãÊòæÁ§∫
        function updateExamples(chainConfig) {
            const amountInput = document.getElementById('amount');
            if (chainConfig && amountInput) {
                const symbol = chainConfig.nativeToken.symbol;
                const placeholder = amountInput.getAttribute('data-original-placeholder') || amountInput.placeholder;
                amountInput.placeholder = placeholder.replace('ETH', symbol);
                
                // Êõ¥Êñ∞Á§∫‰æãÊñáÊú¨
                const small = amountInput.nextElementSibling;
                if (small && small.tagName === 'SMALL') {
                    small.textContent = `Á§∫‰æã: 0.001 ${symbol} = 1000000000000000`;
                }
            }
        }

        // Ëß£ÈîÅÈÖçÁΩÆ
        async function unlockConfig() {
            const password = document.getElementById('unlockPassword').value;
            const btn = document.querySelector('button[onclick="unlockConfig()"]');
            
            if (!password) {
                showResult('unlockResult', { success: false, message: 'ËØ∑ËæìÂÖ•Ëß£ÈîÅÂØÜÁ†Å' }, false);
                return;
            }
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }
            
            setLoading(btn);
            
            try {
                const config = await ConfigManager.loadEncryptedConfig(password);
                setLoading(btn, false);
                
                // Â°´ÂÖÖË°®Âçï
                ConfigManager.fillForm(config);
                
                // ÊòæÁ§∫ÈÖçÁΩÆÁïåÈù¢
                ConfigManager.showConfigInterface();
                
                // ÊòæÁ§∫ÊéßÂà∂ÊåâÈíÆ
                document.getElementById('configControls').style.display = 'block';
                
                // Ê∏ÖÁ©∫ÂØÜÁ†ÅÊ°Ü
                document.getElementById('unlockPassword').value = '';
                
                showResult('unlockResult', { 
                    success: true, 
                    message: `ÈÖçÁΩÆËß£ÈîÅÊàêÂäüÔºÅ‰øùÂ≠òÊó∂Èó¥: ${new Date(config.savedAt).toLocaleString()}` 
                }, true);
                
                // 3ÁßíÂêéÈöêËóèËß£ÈîÅÁªìÊûú
                setTimeout(() => {
                    document.getElementById('unlockResult').style.display = 'none';
                }, 3000);
                
            } catch (error) {
                setLoading(btn, false);
                showResult('unlockResult', { success: false, message: error.message }, false);
            }
        }

        // ÊòæÁ§∫Êñ∞Âª∫ÈÖçÁΩÆË°®Âçï
        function showNewConfigForm() {
            if (confirm('ËøôÂ∞ÜÊ∏ÖÈô§ÂΩìÂâç‰øùÂ≠òÁöÑÈÖçÁΩÆÔºåÁ°ÆÂÆöË¶ÅÊñ∞Âª∫ÈÖçÁΩÆÂêóÔºü')) {
                ConfigManager.clearEncryptedConfig();
                ConfigManager.showConfigInterface();
                document.getElementById('configControls').style.display = 'none';
            }
        }

        // Á°ÆËÆ§Ê∏ÖÈô§ÈÖçÁΩÆ
        function confirmClearConfig() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§‰øùÂ≠òÁöÑÈÖçÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                ConfigManager.clearEncryptedConfig();
                ConfigManager.showConfigInterface();
                document.getElementById('configControls').style.display = 'none';
                showResult('unlockResult', { success: true, message: 'ÈÖçÁΩÆÂ∑≤Ê∏ÖÈô§' }, true);
                setTimeout(() => {
                    document.getElementById('unlockResult').style.display = 'none';
                }, 2000);
            }
        }

        // ÈîÅÂÆöÈÖçÁΩÆ
        function lockConfig() {
            if (confirm('Á°ÆÂÆöË¶ÅÈîÅÂÆöÈÖçÁΩÆÂêóÔºüÈúÄË¶ÅÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†ÅÊâçËÉΩËß£ÈîÅ„ÄÇ')) {
                ConfigManager.lock();
            }
        }

        // ÊòæÁ§∫‰øùÂ≠òÂØÜÁ†ÅÂØπËØùÊ°Ü
        function showSavePasswordDialog() {
            const dialog = document.getElementById('savePasswordDialog');
            dialog.style.display = 'flex';
            document.getElementById('savePassword').focus();
        }

        // ÂÖ≥Èó≠‰øùÂ≠òÂØÜÁ†ÅÂØπËØùÊ°Ü
        function closeSavePasswordDialog() {
            const dialog = document.getElementById('savePasswordDialog');
            dialog.style.display = 'none';
            document.getElementById('savePassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('savePasswordResult').style.display = 'none';
        }

        // Á°ÆËÆ§‰øùÂ≠òÈÖçÁΩÆ
        async function confirmSaveConfig() {
            const password = document.getElementById('savePassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!password || !confirmPassword) {
                showResult('savePasswordResult', { success: false, message: 'ËØ∑Â°´ÂÜôÊâÄÊúâÂØÜÁ†ÅÂ≠óÊÆµ' }, false);
                return;
            }
            
            if (password.length < 8) {
                showResult('savePasswordResult', { success: false, message: 'ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë8‰Ωç' }, false);
                return;
            }
            
            if (password !== confirmPassword) {
                showResult('savePasswordResult', { success: false, message: '‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥' }, false);
                return;
            }
            
            // Êî∂ÈõÜÂΩìÂâçÈÖçÁΩÆ
            const config = {
                okxApiKey: document.getElementById('okxApiKey').value,
                okxSecretKey: document.getElementById('okxSecretKey').value,
                okxPassphrase: document.getElementById('okxPassphrase').value,
                okxProjectId: document.getElementById('okxProjectId').value,
                rpcUrl: document.getElementById('rpcUrl').value,
                chainId: document.getElementById('chainId').value,
                walletAddress: document.getElementById('walletAddress').value,
                privateKey: document.getElementById('privateKey').value
            };
            
            // È™åËØÅÈÖçÁΩÆÂÆåÊï¥ÊÄß
            const requiredFields = ['okxApiKey', 'okxSecretKey', 'okxPassphrase', 'okxProjectId', 'rpcUrl', 'chainId', 'walletAddress', 'privateKey'];
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
                showResult('savePasswordResult', { 
                    success: false, 
                    message: `ËØ∑ÂÖàÂÆåÊï¥Â°´ÂÜôÈÖçÁΩÆ‰ø°ÊÅØÔºåÁº∫Â∞ë: ${missingFields.join(', ')}` 
                }, false);
                return;
            }
            
            try {
                const success = await ConfigManager.saveEncryptedConfig(config, password);
                
                if (success) {
                    showResult('savePasswordResult', { 
                        success: true, 
                        message: 'ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅÂ∑≤Âä†ÂØÜÂ≠òÂÇ®Âà∞Êú¨Âú∞„ÄÇ' 
                    }, true);
                    
                    // 2ÁßíÂêéÂÖ≥Èó≠ÂØπËØùÊ°Ü
                    setTimeout(() => {
                        closeSavePasswordDialog();
                        // ÊòæÁ§∫ÊéßÂà∂ÊåâÈíÆ
                        document.getElementById('configControls').style.display = 'block';
                    }, 2000);
                    
                } else {
                    showResult('savePasswordResult', { success: false, message: '‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•' }, false);
                }
                
            } catch (error) {
                showResult('savePasswordResult', { success: false, message: '‰øùÂ≠òÂ§±Ë¥•: ' + error.message }, false);
            }
        }

        // È™åËØÅOKX APIÈÖçÁΩÆ
        async function validateOKXAPI() {
            const okxApiKey = document.getElementById('okxApiKey').value;
            const okxSecretKey = document.getElementById('okxSecretKey').value;
            const okxPassphrase = document.getElementById('okxPassphrase').value;
            const okxProjectId = document.getElementById('okxProjectId').value;
            const btn = document.querySelector('button[onclick="validateOKXAPI()"]');
            
            // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
            if (!okxApiKey || !okxSecretKey || !okxPassphrase || !okxProjectId) {
                showResult('validateResult', { 
                    success: false, 
                    message: 'ËØ∑ÂÖàÂ°´ÂÜôÂÆåÊï¥ÁöÑOKX APIÈÖçÁΩÆ‰ø°ÊÅØ' 
                }, false);
                return;
            }
            
            if (!btn.getAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.innerHTML);
            }
            
            setLoading(btn);
            
            try {
                const result = await apiCall('/api/validate-okx', 'POST', {
                    okxApiKey,
                    okxSecretKey,
                    okxPassphrase,
                    okxProjectId
                });
                
                setLoading(btn, false);
                
                if (result.success) {
                    showResult('validateResult', {
                        success: true,
                        message: '‚úÖ OKX API ÈÖçÁΩÆÈ™åËØÅÊàêÂäüÔºÅÂèØ‰ª•Ê≠£Â∏∏‰ΩøÁî®„ÄÇ',
                        details: result.data
                    }, true);
                } else {
                    let errorContent = `‚ùå ${result.message}`;
                    
                    if (result.debug) {
                        errorContent += `<br><br><strong>Ë∞ÉËØï‰ø°ÊÅØÔºö</strong><br>`;
                        errorContent += `Áä∂ÊÄÅÁ†Å: ${result.debug.status || 'N/A'}<br>`;
                        errorContent += `ÈîôËØØ: ${result.debug.error || 'N/A'}<br>`;
                        
                        if (result.debug.possibleCauses) {
                            errorContent += `<br><strong>ÂèØËÉΩÂéüÂõ†Ôºö</strong><ul>`;
                            result.debug.possibleCauses.forEach(cause => {
                                errorContent += `<li>${cause}</li>`;
                            });
                            errorContent += `</ul>`;
                        }
                        
                        if (result.response) {
                            errorContent += `<br><strong>OKXÂìçÂ∫îÔºö</strong><br>`;
                            errorContent += `<pre style="font-size: 0.8em; max-height: 200px; overflow-y: auto;">${JSON.stringify(result.response, null, 2)}</pre>`;
                        }
                    }
                    
                    document.getElementById('validateResult').innerHTML = errorContent;
                    document.getElementById('validateResult').className = 'result error';
                    document.getElementById('validateResult').style.display = 'block';
                }
                
            } catch (error) {
                setLoading(btn, false);
                showResult('validateResult', { 
                    success: false, 
                    message: `ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}` 
                }, false);
            }
        }

        // Ê†ºÂºèÂåñ‰∫§Êç¢ÁªìÊûú
        function formatSwapResult(data) {
            console.log('ÂâçÁ´ØÊé•Êî∂Âà∞ÁöÑ‰∫§Êç¢ÁªìÊûú:', data); // Ë∞ÉËØïÊó•Âøó
            
            if (!data) {
                return '‚ùå Ê≤°ÊúâËøîÂõû‰∫§Êç¢Êï∞ÊçÆ';
            }

            let displayContent = '';
            
            // Ê£ÄÊü•‰∫§Êç¢ÊòØÂê¶ÊàêÂäü
            if (data.success === true && data.txHash) {
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">üéâ BSCÈìæ‰∫§Êç¢ÊàêÂäüÔºÅ</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>‰∫§ÊòìÂìàÂ∏å:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.txHash}</code>
                        </div>
                        
                        ${data.orderId ? `
                        <div style="margin-bottom: 6px;">
                            <strong>ËÆ¢ÂçïID:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.orderId}</code>
                        </div>
                        ` : ''}
                        
                        ${data.quote && data.quote.fromToken && data.quote.toToken ? `
                        <div style="margin-bottom: 6px; padding: 4px; background: #f8f9fa; border-radius: 2px;">
                            <strong>‰∫§Êç¢ËØ¶ÊÉÖ:</strong><br>
                            <span style="font-size: 0.85em;">
                                ${(parseFloat(data.quote.fromTokenAmount) / Math.pow(10, parseInt(data.quote.fromToken.decimal || 18))).toFixed(6)} ${data.quote.fromToken.tokenSymbol}
                                ‚Üí 
                                ${(parseFloat(data.quote.toTokenAmount) / Math.pow(10, parseInt(data.quote.toToken.decimal || 18))).toFixed(6)} ${data.quote.toToken.tokenSymbol}
                            </span>
                        </div>
                        ` : ''}
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            ‚úÖ ‰∫§Êç¢Â∑≤Âú®BSCÈìæ‰∏äÊàêÂäüÊâßË°å
                        </div>
                    </div>
                `;
            } else if (data.success === false) {
                displayContent = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #721c24; margin-bottom: 6px;">‚ùå BSCÈìæ‰∫§Êç¢Â§±Ë¥•</div>
                        <div style="font-size: 0.85em; color: #666;">
                            ÈîôËØØ‰ø°ÊÅØ: ${data.error || 'Êú™Áü•ÈîôËØØ'}
                        </div>
                    </div>
                `;
            } else if (data.orderId) {
                // ÂÖºÂÆπÊóßÊ†ºÂºè
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">üéâ ‰∫§Êç¢Êèê‰∫§ÊàêÂäüÔºÅ</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>ËÆ¢ÂçïID:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px;">${data.orderId}</code>
                        </div>
                        
                        ${data.txHash ? `
                        <div style="margin-bottom: 6px;">
                            <strong>‰∫§ÊòìÂìàÂ∏å:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px;">${data.txHash}</code>
                        </div>
                        ` : ''}
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            ‚è≥ ‰∫§Êç¢Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑‰ΩøÁî®ËÆ¢ÂçïIDËøΩË∏™‰∫§ÊòìÁä∂ÊÄÅ
                        </div>
                    </div>
                `;
            } else {
                displayContent = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 6px;">‚ö†Ô∏è ‰∫§Êç¢Áä∂ÊÄÅÊú™Áü•</div>
                        <div style="font-size: 0.85em; color: #666;">
                            Ê≤°ÊúâÊî∂Âà∞ÊòéÁ°ÆÁöÑ‰∫§Êç¢ÁªìÊûúÔºåËØ∑Ê£ÄÊü•‰∫§Êç¢ÊòØÂê¶ÊàêÂäüÊèê‰∫§
                        </div>
                        <pre style="font-size: 0.75em; background: #f8f9fa; padding: 4px; border-radius: 2px; margin-top: 4px; max-height: 100px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            }

            return displayContent;
        }

        // Ê†ºÂºèÂåñÊéàÊùÉÁªìÊûú
        function formatApprovalResult(data) {
            console.log('ÂâçÁ´ØÊé•Êî∂Âà∞ÁöÑÊéàÊùÉÁªìÊûú:', data); // Ë∞ÉËØïÊó•Âøó
            
            if (!data) {
                return '‚ùå Ê≤°ÊúâËøîÂõûÊéàÊùÉÊï∞ÊçÆ';
            }

            let displayContent = '';
            
            if (data.needApproval === false) {
                displayContent = `
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #0c5460; margin-bottom: 6px;">‚ÑπÔ∏è BSC‰ª£Â∏ÅÂ∑≤ÁªèÊéàÊùÉ</div>
                        <div style="font-size: 0.85em; color: #666;">
                            ËØ•‰ª£Â∏ÅÂ∑≤ÁªèÊúâË∂≥Â§üÁöÑÊéàÊùÉÈ¢ùÂ∫¶ÔºåÂèØ‰ª•Áõ¥Êé•ËøõË°å‰∫§Êç¢
                        </div>
                    </div>
                `;
            } else if (data.needApproval === true && data.txHash) {
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">‚úÖ BSCÈìæÊéàÊùÉ‰∫§ÊòìÊàêÂäü</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>‰∫§ÊòìÂìàÂ∏å:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.txHash}</code>
                        </div>
                        
                        ${data.orderId ? `
                        <div style="margin-bottom: 6px;">
                            <strong>ËÆ¢ÂçïID:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px; word-break: break-all; font-size: 0.8em;">${data.orderId}</code>
                        </div>
                        ` : ''}
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            ‚úÖ ‰ª£Â∏ÅÊéàÊùÉÂ∑≤Âú®BSCÈìæ‰∏äÊàêÂäüÊâßË°åÔºåÁé∞Âú®ÂèØ‰ª•ËøõË°å‰∫§Êç¢
                        </div>
                    </div>
                `;
            } else if (data.txHash) {
                // ÂÖºÂÆπÊóßÊ†ºÂºè
                displayContent = `
                    <div style="background: #d4edda; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">‚úÖ ÊéàÊùÉ‰∫§ÊòìÂ∑≤Êèê‰∫§</div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong>‰∫§ÊòìÂìàÂ∏å:</strong> <code style="background: #e8f5e8; padding: 2px 4px; border-radius: 2px;">${data.txHash}</code>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #666; border-top: 1px solid #c8e6c9; padding-top: 6px; margin-top: 8px;">
                            ‚è≥ ÊéàÊùÉ‰∫§ÊòìÊ≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåÂÆåÊàêÂêéÂç≥ÂèØËøõË°å‰ª£Â∏Å‰∫§Êç¢
                        </div>
                    </div>
                `;
            } else {
                displayContent = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 4px 0;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 6px;">‚ö†Ô∏è ÊéàÊùÉÁä∂ÊÄÅÊú™Áü•</div>
                        <div style="font-size: 0.85em; color: #666;">
                            ÊéàÊùÉÁªìÊûú‰∏çÊòéÁ°ÆÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖÊàñÈáçÊñ∞Â∞ùËØï
                        </div>
                        <pre style="font-size: 0.75em; background: #f8f9fa; padding: 4px; border-radius: 2px; margin-top: 4px; max-height: 100px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            }

            return displayContent;
        }
    </script>
</body>
</html> 